{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Catálogo JEMA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --jema-purple: #6B2D7B;
            --jema-purple-light: rgba(107, 45, 123, 0.1);
            --jema-teal: #1A9A9A;
            --jema-magenta: #E91E8C;
            --jema-gradient: linear-gradient(135deg, #6B2D7B 0%, #E91E8C 100%);
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            background: linear-gradient(135deg, #f8f5fa 0%, #f0f7f7 100%);
            font-family: 'Poppins', sans-serif;
            overflow: hidden;
        }

        /* Contenedor Scroll Snap (TikTok Style) */
        .feed-container {
            height: 100vh;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
            scroll-behavior: smooth;
        }

        /* Cada Producto es una pantalla completa */
        .product-slide {
            height: 100vh;
            width: 100%;
            scroll-snap-align: start;
            position: relative;
            display: flex;
            flex-direction: column;
            padding: 15px;
            padding-top: 70px;
        }

        /* Card Unificada */
        .product-card-unified {
            flex: 1;
            background: white;
            border-radius: 24px;
            box-shadow: 0 10px 40px rgba(107, 45, 123, 0.08);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            max-height: calc(100vh - 100px);
        }

        /* Sección Imagen */
        .slide-image {
            height: 50%;
            min-height: 45%;
            width: 100%;
            position: relative;
            background: linear-gradient(180deg, #fafafa 0%, #f5f5f5 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .slide-image img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }
        
        /* Badge Categoría */
        .category-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: white;
            color: var(--jema-purple);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid rgba(107, 45, 123, 0.15);
        }
        
        /* Placeholder imagen */
        .image-placeholder {
            width: 150px;
            height: 150px;
            background: linear-gradient(135deg, var(--jema-purple-light) 0%, rgba(26, 154, 154, 0.1) 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .image-placeholder i {
            font-size: 3rem;
            color: var(--jema-purple);
            opacity: 0.5;
        }

        /* Sección Detalles */
        .slide-details {
            flex: 1;
            padding: 24px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            border-top: 1px solid rgba(107, 45, 123, 0.08);
        }
        
        .product-name {
            font-size: 1.4rem;
            font-weight: 700;
            color: #1a1a2e;
            margin-bottom: 4px;
        }
        
        .product-description {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 16px;
            line-height: 1.4;
        }
        
        .options-section {
            margin-bottom: 16px;
        }
        
        .option-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--jema-purple);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        /* Botones de opciones JEMA */
        .options-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .option-btn {
            border: 2px solid #e9ecef;
            background: white;
            color: #495057;
            padding: 10px 18px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.25s ease;
            cursor: pointer;
        }
        
        .option-btn:hover {
            border-color: var(--jema-teal);
            color: var(--jema-teal);
            background: rgba(26, 154, 154, 0.05);
        }
        
        .option-btn.active {
            border-color: var(--jema-purple);
            background: var(--jema-purple-light);
            color: var(--jema-purple);
            font-weight: 600;
        }

        /* Footer de compra */
        .purchase-footer {
            padding-top: 16px;
            border-top: 1px solid #f0f0f0;
        }
        
        .price-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .price-label {
            font-size: 0.85rem;
            color: #6c757d;
        }
        
        .price-value {
            font-size: 1.6rem;
            font-weight: 700;
            background: var(--jema-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Selector de cantidad JEMA */
        .qty-selector {
            display: flex;
            align-items: center;
            background: #f8f9fa;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #e9ecef;
        }
        
        .qty-btn {
            width: 44px;
            height: 44px;
            border: none;
            background: transparent;
            font-size: 1.2rem;
            color: var(--jema-purple);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .qty-btn:hover {
            background: var(--jema-purple-light);
        }
        
        .qty-btn:active {
            background: var(--jema-purple);
            color: white;
        }
        
        .qty-value {
            width: 50px;
            text-align: center;
            font-weight: 600;
            font-size: 1rem;
            color: #1a1a2e;
            border: none;
            background: transparent;
        }

        /* Botón Agregar al Carrito JEMA */
        .btn-add-cart {
            width: 100%;
            padding: 16px 24px;
            border: none;
            border-radius: 14px;
            font-size: 1rem;
            font-weight: 600;
            color: white;
            background: var(--jema-gradient);
            box-shadow: 0 8px 25px rgba(107, 45, 123, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-add-cart:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(107, 45, 123, 0.4);
        }
        
        .btn-add-cart:active {
            transform: translateY(0);
        }
        
        .btn-add-cart i {
            font-size: 1.1rem;
        }

        /* Animación de inicio */
        .swipe-hint {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            color: white;
            background: var(--jema-gradient);
            padding: 12px 24px;
            border-radius: 30px;
            animation: bounce 2s infinite;
            pointer-events: none;
            font-size: 0.85rem;
            font-weight: 500;
            box-shadow: 0 8px 25px rgba(107, 45, 123, 0.3);
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateX(-50%) translateY(0);}
            40% {transform: translateX(-50%) translateY(-8px);}
            60% {transform: translateX(-50%) translateY(-4px);}
        }
        
        /* Botón Flotante Volver JEMA */
        .btn-back {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
            background: white;
            border: none;
            border-radius: 14px;
            width: 48px;
            height: 48px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .btn-back:hover {
            background: var(--jema-purple-light);
        }
        
        .btn-back i {
            font-size: 1.2rem;
            color: var(--jema-purple);
        }
        
        /* Scrollbar oculta */
        .feed-container::-webkit-scrollbar {
            display: none;
        }
        
        .feed-container {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body>

    <div class="swipe-hint" id="swipeHint">
        <i class="bi bi-chevron-up me-2"></i> Desliza hacia arriba
    </div>

    <a href="{% url 'home' %}" class="btn-back">
        <i class="bi bi-arrow-left"></i>
    </a>

    <div class="feed-container" id="feedContainer">
        {% for product in products %}
        <div class="product-slide" data-product-id="{{ product.id }}">
            <div class="product-card-unified">
                <!-- Imagen -->
                <div class="slide-image">
                    {% if product.image %}
                        <img src="{{ product.image.url }}" alt="{{ product.name }}">
                    {% else %}
                        <div class="image-placeholder">
                            <i class="bi bi-image"></i>
                        </div>
                    {% endif %}
                    
                    <span class="category-badge">
                        {{ product.category.name }}
                    </span>
                </div>

                <!-- Detalles -->
                <div class="slide-details">
                    <div class="details-content">
                        <h2 class="product-name">{{ product.name }}</h2>
                        <p class="product-description">{{ product.description|default:"Sin descripción" }}</p>
                        
                        <div class="options-section">
                            <!-- Tamaño -->
                            <p class="option-label">Tamaño</p>
                            <div class="options-wrapper" id="size-options-{{ product.id }}">
                                <!-- Se llenan con JS -->
                            </div>
                        </div>
                        
                        <div class="options-section">
                            <p class="option-label">Color / Material</p>
                            <div class="options-wrapper" id="color-options-{{ product.id }}">
                                <!-- Se llenan con JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Footer de compra -->
                    <div class="purchase-footer">
                        <div class="price-row">
                            <div>
                                <span class="price-label">Precio Total</span>
                                <div class="price-value" id="price-{{ product.id }}">$0.00</div>
                            </div>
                            
                            <div class="qty-selector">
                                <button class="qty-btn" onclick="changeQty({{ product.id }}, -1)">
                                    <i class="bi bi-dash"></i>
                                </button>
                                <input type="text" class="qty-value" id="qty-{{ product.id }}" value="1" readonly>
                                <button class="qty-btn" onclick="changeQty({{ product.id }}, 1)">
                                    <i class="bi bi-plus"></i>
                                </button>
                            </div>
                        </div>

                        <button class="btn-add-cart" onclick="addToCart({{ product.id }})">
                            <i class="bi bi-cart-plus"></i>
                            Agregar al Carrito
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- JSON de variantes -->
    {{ variants_json|json_script:"variants-data" }}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Ocultar hint después de primer scroll
        const feedContainer = document.getElementById('feedContainer');
        const swipeHint = document.getElementById('swipeHint');
        
        feedContainer.addEventListener('scroll', function() {
            if (feedContainer.scrollTop > 50) {
                swipeHint.style.opacity = '0';
                swipeHint.style.transition = 'opacity 0.3s ease';
                setTimeout(() => swipeHint.style.display = 'none', 300);
            }
        }, { once: true });

        // Cargar variantes
        const variantsData = JSON.parse(document.getElementById('variants-data').textContent);
        
        // Inicializar opciones para cada producto
        document.querySelectorAll('.product-slide').forEach(slide => {
            const productId = slide.dataset.productId;
            const variants = variantsData[productId] || { sizes: [], colors: [] };
            
            const sizeContainer = document.getElementById(`size-options-${productId}`);
            const colorContainer = document.getElementById(`color-options-${productId}`);
            
            variants.sizes.forEach((size, index) => {
                const btn = document.createElement('button');
                btn.className = `option-btn${index === 0 ? ' active' : ''}`;
                btn.textContent = size.name;
                btn.dataset.price = size.price;
                btn.onclick = () => selectOption(btn, productId, 'size');
                sizeContainer.appendChild(btn);
            });
            
            variants.colors.forEach((color, index) => {
                const btn = document.createElement('button');
                btn.className = `option-btn${index === 0 ? ' active' : ''}`;
                btn.textContent = color;
                btn.onclick = () => selectOption(btn, productId, 'color');
                colorContainer.appendChild(btn);
            });
            
            updatePrice(productId);
        });
        
        function selectOption(btn, productId, type) {
            const container = btn.parentElement;
            container.querySelectorAll('.option-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updatePrice(productId);
        }
        
        function updatePrice(productId) {
            const sizeBtn = document.querySelector(`#size-options-${productId} .option-btn.active`);
            const qty = parseInt(document.getElementById(`qty-${productId}`).value) || 1;
            const price = sizeBtn ? parseFloat(sizeBtn.dataset.price) || 0 : 0;
            const total = price * qty;
            document.getElementById(`price-${productId}`).textContent = `$${total.toLocaleString('es-CO', {minimumFractionDigits: 2})}`;
        }
        
        function changeQty(productId, delta) {
            const input = document.getElementById(`qty-${productId}`);
            let qty = parseInt(input.value) || 1;
            qty = Math.max(1, qty + delta);
            input.value = qty;
            updatePrice(productId);
        }
        
        function addToCart(productId) {
            const sizeBtn = document.querySelector(`#size-options-${productId} .option-btn.active`);
            const colorBtn = document.querySelector(`#color-options-${productId} .option-btn.active`);
            const qty = document.getElementById(`qty-${productId}`).value;
            
            console.log('Agregar al carrito:', {
                productId,
                size: sizeBtn?.textContent,
                color: colorBtn?.textContent,
                qty
            });
            
            // Aquí tu lógica de agregar al carrito
        }
    </script>
</body>
</html>
