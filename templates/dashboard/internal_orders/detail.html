{% extends 'base_admin.html' %}

{% block title %}Pedido #{{ order.id }} - JEMA{% endblock %}
{% block page_title %}Detalle de Pedido{% endblock %}

{% block extra_css %}
<style>
    .detail-header {
        background: linear-gradient(135deg, var(--jema-purple) 0%, var(--jema-teal) 100%);
        border-radius: 16px;
        padding: 24px;
        color: white;
        margin-bottom: 24px;
    }

    .detail-header h3 {
        margin: 0;
        font-weight: 700;
    }

    .detail-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 16px;
        margin-top: 20px;
    }

    .detail-stat {
        background: rgba(255, 255, 255, 0.15);
        border-radius: 12px;
        padding: 16px;
        text-align: center;
    }

    .detail-stat h4 {
        font-size: 28px;
        margin: 0;
        font-weight: 700;
    }

    .detail-stat span {
        font-size: 13px;
        opacity: 0.9;
    }

    .items-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 16px;
    }

    .item-card {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 16px;
        box-shadow: var(--shadow-sm);
        display: flex;
        gap: 12px;
    }

    .item-card img {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 8px;
        flex-shrink: 0;
    }

    .item-info {
        flex: 1;
        min-width: 0;
    }

    .item-info h6 {
        font-size: 13px;
        margin: 0 0 4px 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .item-info small {
        color: var(--muted-foreground);
        font-size: 11px;
    }

    .item-info .price {
        font-weight: 700;
        color: var(--jema-teal);
        font-size: 14px;
    }

    .item-qty {
        background: var(--muted);
        border-radius: 8px;
        padding: 4px 10px;
        font-weight: 700;
        font-size: 14px;
        display: inline-block;
        margin-top: 8px;
    }

    .status-timeline {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 16px;
    }

    .status-timeline form {
        display: inline;
    }

    .status-btn {
        padding: 8px 16px;
        border-radius: 20px;
        border: 2px solid var(--border);
        background: white;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        transition: all 0.2s;
    }

    .status-btn:hover {
        border-color: var(--jema-purple);
    }

    .status-btn.active {
        background: var(--jema-purple);
        color: white;
        border-color: var(--jema-purple);
    }

    .print-section {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 20px;
        margin-top: 24px;
    }

    @media print {
        .no-print {
            display: none !important;
        }

        .detail-header {
            background: #6B2D7B !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        .item-card {
            break-inside: avoid;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Back button -->
    <div class="mb-3 no-print">
        <a href="{% url 'internal_orders_list' %}" class="text-muted text-decoration-none">
            <i class="bi bi-arrow-left"></i> Volver a pedidos
        </a>
    </div>

    <!-- Header -->
    <div class="detail-header">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
            <div>
                <h3><i class="bi bi-box-seam me-2"></i>{{ order.name }}</h3>
                {% if order.description %}
                <p class="mb-0 mt-2 opacity-75">{{ order.description }}</p>
                {% endif %}
            </div>
            <div class="no-print">
                <span class="badge bg-light text-dark fs-6">
                    {{ order.get_status_display }}
                </span>
            </div>
        </div>

        <div class="detail-stats">
            <div class="detail-stat">
                <h4>{{ order.total_items }}</h4>
                <span>Referencias</span>
            </div>
            <div class="detail-stat">
                <h4>${{ order.total_estimated|floatformat:0 }}</h4>
                <span>Total Estimado</span>
            </div>
            <div class="detail-stat">
                <h4>{{ order.created_at|date:"d/m/Y" }}</h4>
                <span>Fecha Creación</span>
            </div>
            <div class="detail-stat">
                <h4>{{ order_items.count }}</h4>
                <span>Líneas</span>
            </div>
        </div>
    </div>

    <!-- Status Change -->
    <div class="card mb-4 no-print">
        <div class="card-body">
            <h6 class="mb-3"><i class="bi bi-arrow-repeat"></i> Cambiar Estado</h6>
            <div class="status-timeline">
                {% for code, name in order.STATUS_CHOICES %}
                <form method="post" action="{% url 'internal_order_update_status' order.id %}">
                    {% csrf_token %}
                    <input type="hidden" name="status" value="{{ code }}">
                    <button type="submit" class="status-btn {% if order.status == code %}active{% endif %}">
                        {% if code == 'draft' %}<i class="bi bi-pencil"></i>
                        {% elif code == 'confirmed' %}<i class="bi bi-check-circle"></i>
                        {% elif code == 'in_production' %}<i class="bi bi-gear"></i>
                        {% elif code == 'completed' %}<i class="bi bi-trophy"></i>
                        {% elif code == 'cancelled' %}<i class="bi bi-x-circle"></i>
                        {% endif %}
                        {{ name }}
                    </button>
                </form>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="d-flex gap-2 mb-4 no-print flex-wrap">
        <a href="{% url 'internal_order_edit' order.id %}" class="btn btn-jema-primary">
            <i class="bi bi-pencil"></i> Editar Pedido
        </a>
        <a href="{% url 'internal_order_tasks' order.id %}" class="btn btn-jema-teal">
            <i class="bi bi-check2-square"></i> Gestionar Tareas
        </a>
        <button class="btn btn-outline-secondary" onclick="window.print()">
            <i class="bi bi-printer"></i> Imprimir
        </button>
    </div>

    <!-- Items -->
    <div class="card">
        <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-list-ul"></i> Items del Pedido</h5>
        </div>
        <div class="card-body">
            {% if order_items %}
            <div class="items-grid">
                {% for item in order_items %}
                <div class="item-card">
                    {% if item.variant.product.image %}
                    <img src="{{ item.variant.product.image.url }}" alt="">
                    {% else %}
                    <img src="https://via.placeholder.com/60x60?text=IMG" alt="">
                    {% endif %}
                    <div class="item-info">
                        <h6 title="{{ item.product_name }}">{{ item.product_name }}</h6>
                        <small>{{ item.variant_details }}</small>
                        <div class="d-flex justify-content-between align-items-center mt-1">
                            <span class="price">${{ item.unit_price|floatformat:0 }}</span>
                            <span class="item-qty">x{{ item.quantity }}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-5 text-muted">
                <i class="bi bi-inbox" style="font-size: 48px;"></i>
                <p class="mt-2">Este pedido no tiene items</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Estado Financiero -->
    <div class="card mb-4 no-print">
        <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-cash-stack"></i> Estado Financiero</h5>
        </div>
        <div class="card-body">
            {% if financial_status %}
            <div class="d-flex align-items-center gap-3 flex-wrap">
                <span class="badge {{ financial_status.get_state_badge_class }} fs-6" id="fsBadge">
                    {{ financial_status.get_state_display }}
                </span>
                <div class="d-flex gap-2">
                    {% if financial_status.state == 'creado' %}
                    <button class="btn btn-sm btn-outline-primary" onclick="transitionFinancialState({{ financial_status.id }}, 'enviado')">
                        <i class="bi bi-truck"></i> Marcar Enviado
                    </button>
                    {% endif %}
                    {% if financial_status.state == 'enviado' %}
                    <button class="btn btn-sm btn-outline-success" onclick="transitionFinancialState({{ financial_status.id }}, 'cobrado')">
                        <i class="bi bi-cash-coin"></i> Marcar Cobrado
                    </button>
                    {% endif %}
                    {% if financial_status.state != 'cancelado' %}
                    <button class="btn btn-sm btn-outline-danger" onclick="transitionFinancialState({{ financial_status.id }}, 'cancelado')">
                        <i class="bi bi-x-lg"></i> Cancelar
                    </button>
                    {% endif %}
                </div>
                <div class="ms-auto">
                    <button class="btn btn-sm btn-outline-secondary" onclick="loadProfitability({{ financial_status.id }})">
                        <i class="bi bi-calculator"></i> Ver Rentabilidad
                    </button>
                </div>
            </div>
            <div id="profitData" class="mt-3" style="display: none;">
                <div class="row g-2">
                    <div class="col-md-2"><div class="bg-light rounded p-2 text-center"><small class="text-muted d-block">Venta</small><strong id="pSale">—</strong></div></div>
                    <div class="col-md-2"><div class="bg-light rounded p-2 text-center"><small class="text-muted d-block">Costos</small><strong id="pCosts" class="text-danger">—</strong></div></div>
                    <div class="col-md-2"><div class="bg-light rounded p-2 text-center"><small class="text-muted d-block">Envio</small><strong id="pShipping">—</strong></div></div>
                    <div class="col-md-3"><div class="bg-light rounded p-2 text-center"><small class="text-muted d-block">Overhead</small><strong id="pOverhead" class="text-warning">—</strong></div></div>
                    <div class="col-md-3"><div class="bg-light rounded p-2 text-center"><small class="text-muted d-block">Utilidad</small><strong id="pProfit">—</strong></div></div>
                </div>
            </div>
            {% else %}
            <p class="text-muted mb-0">Sin estado financiero asignado.</p>
            {% endif %}
        </div>
    </div>

    <!-- Costos de Producción -->
    <div class="card mb-4 no-print" id="costsSection">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-calculator"></i> Costos de Producción</h5>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-jema-primary" onclick="calculateCosts()" id="btnCalcCosts">
                    <i class="bi bi-calculator"></i> Calcular Costos
                </button>
                <a href="{% url 'cost_config' %}" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-gear"></i> Configuración
                </a>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm mb-0" id="costsTable">
                    <thead class="bg-light">
                        <tr>
                            <th>Tipo de Costo</th>
                            <th>Descripción</th>
                            <th class="text-end">Cantidad</th>
                            <th class="text-end">Precio Unit.</th>
                            <th class="text-end">Total</th>
                        </tr>
                    </thead>
                    <tbody id="costsBody">
                        {% for breakdown in cost_breakdowns %}
                        <tr>
                            <td>{{ breakdown.cost_type.name }}</td>
                            <td>{{ breakdown.description }}</td>
                            <td class="text-end">{{ breakdown.calculated_quantity }}</td>
                            <td class="text-end">${{ breakdown.unit_price|floatformat:0 }}</td>
                            <td class="text-end fw-bold">${{ breakdown.total|floatformat:0 }}</td>
                        </tr>
                        {% empty %}
                        <tr id="noCostsRow">
                            <td colspan="5" class="text-center text-muted py-3">
                                <i class="bi bi-info-circle"></i> No hay costos calculados. Presiona "Calcular Costos".
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Envío y Descuento -->
            <div class="border-top pt-3 mt-3">
                <div class="row g-3 align-items-center">
                    <div class="col-md-4">
                        <label class="form-label fw-bold mb-0"><i class="bi bi-truck"></i> Costo de Envío</label>
                    </div>
                    <div class="col-md-2">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text">$</span>
                            <input type="number" step="1" min="0" class="form-control"
                                id="shippingCostInput" value="{{ order.shipping_cost|floatformat:0 }}"
                                onchange="updateShipping()">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold mb-0 text-danger"><i class="bi bi-percent"></i> Descuento Especial</label>
                    </div>
                    <div class="col-md-2">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text">$</span>
                            <input type="number" step="1" min="0" class="form-control text-danger fw-bold"
                                id="discountInput" value="{{ order.discount_amount|floatformat:0 }}"
                                onchange="updateDiscount()">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Totales -->
            <div class="border-top pt-3 mt-3" id="costsTotals">
                <div class="d-flex justify-content-between mb-1">
                    <span>Total Costos Producción:</span>
                    <span class="fw-bold" id="totalProduction">${{ total_production_cost|floatformat:0|default:"0" }}</span>
                </div>
                <div class="d-flex justify-content-between mb-1">
                    <span>Descuento:</span>
                    <span class="fw-bold text-danger" id="totalDiscount">-${{ order.discount_amount|floatformat:0 }}</span>
                </div>
                <div class="d-flex justify-content-between mb-1 border-top pt-2">
                    <span class="fw-bold">Total Costos:</span>
                    <span class="fw-bold text-danger" id="grandTotal">${{ grand_total_cost|floatformat:0|default:"0" }}</span>
                </div>
                <div class="d-flex justify-content-between mb-1">
                    <span>Total Estimado (Venta):</span>
                    <span class="fw-bold text-success" id="totalEstimatedDisplay">${{ order.total_estimated|floatformat:0 }}</span>
                </div>
                <div class="d-flex justify-content-between">
                    <span class="fw-bold">Margen:</span>
                    <span class="fw-bold {% if margin >= 0 %}text-success{% else %}text-danger{% endif %}" id="marginDisplay">
                        ${{ margin|floatformat:0|default:"0" }}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Print Summary -->
    <div class="print-section" style="display: none;">
        <h5>Resumen de Pedido</h5>
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Variante</th>
                    <th>Cant.</th>
                    <th>Precio</th>
                </tr>
            </thead>
            <tbody>
                {% for item in order_items %}
                <tr>
                    <td>{{ item.product_name }}</td>
                    <td>{{ item.variant_details }}</td>
                    <td>{{ item.quantity }}</td>
                    <td>${{ item.unit_price|floatformat:0 }}</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr>
                    <th colspan="2">Total</th>
                    <th>{{ order.total_items }}</th>
                    <th>${{ order.total_estimated|floatformat:0 }}</th>
                </tr>
            </tfoot>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const csrfToken = '{{ csrf_token }}';
const orderId = {{ order.id }};

function calculateCosts() {
    const btn = document.getElementById('btnCalcCosts');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Calculando...';

    fetch('{% url "api_calculate_costs" %}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
        body: JSON.stringify({order_type: 'internal', order_id: orderId})
    })
    .then(r => r.json())
    .then(res => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Recalcular';

        if (!res.ok) {
            alert('Error: ' + res.error);
            return;
        }

        const tbody = document.getElementById('costsBody');
        tbody.innerHTML = '';

        if (res.breakdowns.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-3">No se encontraron costos configurados para los productos de este pedido.</td></tr>';
        } else {
            res.breakdowns.forEach(b => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${b.cost_type_name}</td>
                    <td>${b.description}</td>
                    <td class="text-end">${parseFloat(b.quantity).toFixed(2)}</td>
                    <td class="text-end">$${parseInt(b.unit_price).toLocaleString()}</td>
                    <td class="text-end fw-bold">$${parseInt(b.total).toLocaleString()}</td>
                `;
                tbody.appendChild(row);
            });
        }

        const shipping = parseFloat(document.getElementById('shippingCostInput').value) || 0;
        const totalProd = parseFloat(res.total_production) + parseFloat(res.total_manual);
        const grandTotal = totalProd + shipping;
        const totalEstimated = {{ order.total_estimated|default:"0" }};
        const margin = totalEstimated - grandTotal;

        document.getElementById('totalProduction').textContent = '$' + Math.round(totalProd).toLocaleString();
        document.getElementById('totalShipping').textContent = '$' + Math.round(shipping).toLocaleString();
        document.getElementById('grandTotal').textContent = '$' + Math.round(grandTotal).toLocaleString();
        document.getElementById('marginDisplay').textContent = '$' + Math.round(margin).toLocaleString();
        document.getElementById('marginDisplay').className = 'fw-bold ' + (margin >= 0 ? 'text-success' : 'text-danger');
    })
    .catch(err => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-calculator"></i> Calcular Costos';
        alert('Error de conexión');
    });
}

function updateShipping() {
    const val = document.getElementById('shippingCostInput').value || 0;
    fetch('{% url "api_update_shipping" %}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
        body: JSON.stringify({order_type: 'internal', order_id: orderId, shipping_cost: val})
    })
    .then(r => r.json())
    .then(res => {
        if (res.ok) {
            document.getElementById('totalShipping').textContent = '$' + parseInt(val).toLocaleString();
            const totalProdText = document.getElementById('totalProduction').textContent.replace(/[$,]/g, '');
            const totalProd = parseInt(totalProdText) || 0;
            const grandTotal = totalProd + parseInt(val);
            const totalEstimated = {{ order.total_estimated|default:"0" }};
            const margin = totalEstimated - grandTotal;
            document.getElementById('grandTotal').textContent = '$' + grandTotal.toLocaleString();
            document.getElementById('marginDisplay').textContent = '$' + margin.toLocaleString();
            document.getElementById('marginDisplay').className = 'fw-bold ' + (margin >= 0 ? 'text-success' : 'text-danger');
        }
    });
}

function updateDiscount() {
    const val = document.getElementById('discountInput').value || 0;
    fetch('{% url "api_update_discount" %}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
        body: JSON.stringify({order_type: 'internal', order_id: orderId, discount_amount: val})
    })
    .then(r => r.json())
    .then(res => {
        if (res.ok) {
            document.getElementById('totalDiscount').textContent = '-$' + parseInt(val).toLocaleString();
            document.getElementById('totalEstimatedDisplay').textContent = '$' + parseInt(res.total_estimated).toLocaleString();
            
            // Recalcular margen
            const totalEstimated = parseFloat(res.total_estimated);
            const grandTotalText = document.getElementById('grandTotal').textContent.replace(/[$,]/g, '');
            const grandTotal = parseFloat(grandTotalText) || 0;
            const margin = totalEstimated - grandTotal;
            
            document.getElementById('marginDisplay').textContent = '$' + Math.round(margin).toLocaleString();
            document.getElementById('marginDisplay').className = 'fw-bold ' + (margin >= 0 ? 'text-success' : 'text-danger');
        }
    });
}

function transitionFinancialState(fsId, newState) {
    const labels = {enviado: 'Enviado', cobrado: 'Cobrado', cancelado: 'Cancelado'};
    if (!confirm('Cambiar estado financiero a ' + labels[newState] + '?')) return;

    fetch('{% url "api_jc_transition" %}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
        body: JSON.stringify({financial_status_id: fsId, new_state: newState})
    })
    .then(r => r.json())
    .then(res => {
        if (res.ok) location.reload();
        else alert(res.message || 'Error');
    })
    .catch(() => alert('Error de conexion'));
}

function loadProfitability(fsId) {
    fetch('{% url "api_jc_profitability" %}?financial_status_id=' + fsId)
    .then(r => r.json())
    .then(res => {
        if (!res.ok) { alert(res.error); return; }
        document.getElementById('profitData').style.display = 'block';
        document.getElementById('pSale').textContent = '$' + parseInt(res.sale_amount).toLocaleString();
        document.getElementById('pCosts').textContent = '-$' + parseInt(res.direct_costs).toLocaleString();
        document.getElementById('pShipping').textContent = '-$' + parseInt(res.shipping_cost).toLocaleString();
        document.getElementById('pOverhead').textContent = '-$' + parseInt(res.overhead_amount).toLocaleString() + ' (' + parseFloat(res.overhead_percentage).toFixed(2) + '%)';
        const profit = parseFloat(res.net_profit);
        const el = document.getElementById('pProfit');
        el.textContent = '$' + parseInt(res.net_profit).toLocaleString();
        el.className = profit >= 0 ? 'text-success' : 'text-danger';
    })
    .catch(() => alert('Error de conexion'));
}
</script>
{% endblock %}
