{% extends 'base_admin.html' %}

{% block title %}Pedido #{{ order.id }} - JEMA{% endblock %}
{% block page_title %}Detalle de Pedido{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="mb-3 no-print">
        <a href="{% url 'internal_orders_list' %}" class="text-muted text-decoration-none">
            <i class="bi bi-arrow-left"></i> Volver a pedidos
        </a>
    </div>

    <div class="card mb-4">
        <div class="card-body d-flex justify-content-between flex-wrap gap-3">
            <div>
                <h4 class="mb-1">{{ order.name }}</h4>
                {% if order.description %}<p class="text-muted mb-0">{{ order.description }}</p>{% endif %}
            </div>
            <div class="text-end">
                <div><small class="text-muted">Total Neto (Ingresos - Gastos)</small></div>
                <div class="fw-bold fs-4">${{ order.total_estimated|floatformat:0 }}</div>
                <div><small class="text-muted">Items: {{ order.total_items }}</small></div>
            </div>
        </div>
    </div>

    <div class="card mb-4 no-print">
        <div class="card-body">
            <h6 class="mb-3"><i class="bi bi-arrow-repeat"></i> Cambiar Estado</h6>
            <div class="d-flex gap-2 flex-wrap">
                {% for code, name in order.STATUS_CHOICES %}
                <form method="post" action="{% url 'internal_order_update_status' order.id %}">
                    {% csrf_token %}
                    <input type="hidden" name="status" value="{{ code }}">
                    <button type="submit" class="btn btn-sm {% if order.status == code %}btn-primary{% else %}btn-outline-secondary{% endif %}">
                        {{ name }}
                    </button>
                </form>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="d-flex gap-2 mb-4 no-print flex-wrap">
        <a href="{% url 'internal_order_edit' order.id %}" class="btn btn-jema-primary">
            <i class="bi bi-pencil"></i> Editar Pedido
        </a>
        <a href="{% url 'internal_order_tasks' order.id %}" class="btn btn-jema-teal">
            <i class="bi bi-check2-square"></i> Gestionar Tareas
        </a>
        <button class="btn btn-outline-secondary" onclick="window.print()">
            <i class="bi bi-printer"></i> Imprimir
        </button>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-list-ul"></i> Items del Pedido</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th style="width: 60px;">Imagen</th>
                            <th>Producto</th>
                            <th>Variante</th>
                            <th class="text-end">Cantidad</th>
                            <th class="text-end">Precio</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in order_items %}
                        <tr>
                            <td>
                                {% if item.variant.product.image %}
                                    <img src="{{ item.variant.product.image.url }}" class="img-thumbnail" style="width: 50px; height: 50px; object-fit: cover;" alt="{{ item.product_name }}">
                                {% else %}
                                    <div class="bg-light d-flex align-items-center justify-content-center border rounded" style="width: 50px; height: 50px;">
                                        <i class="bi bi-image text-muted"></i>
                                    </div>
                                {% endif %}
                            </td>
                            <td>{{ item.product_name }}</td>
                            <td>{{ item.variant_details }}</td>
                            <td class="text-end">{{ item.quantity }}</td>
                            <td class="text-end">${{ item.unit_price|floatformat:0 }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="5" class="text-center text-muted">Sin items</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="card mb-4 no-print">
        <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-cash-stack"></i> Estado Financiero</h5>
        </div>
        <div class="card-body">
            {% if financial_status %}
            <div class="d-flex align-items-center gap-2 flex-wrap">
                <span class="badge {{ financial_status.get_state_badge_class }} fs-6">{{ financial_status.get_state_display }}</span>
                {% if financial_status.state == 'creado' %}
                <button class="btn btn-sm btn-outline-primary" onclick="transitionFinancialState({{ financial_status.id }}, 'enviado')">Marcar Enviado</button>
                {% endif %}
                {% if financial_status.state == 'enviado' %}
                <button class="btn btn-sm btn-outline-success" onclick="transitionFinancialState({{ financial_status.id }}, 'cobrado')">Marcar Cobrado</button>
                {% endif %}
                {% if financial_status.state != 'cancelado' %}
                <button class="btn btn-sm btn-outline-danger" onclick="transitionFinancialState({{ financial_status.id }}, 'cancelado')">Cancelar</button>
                {% endif %}
                <button class="btn btn-sm btn-outline-secondary ms-auto" onclick="loadProfitability({{ financial_status.id }})">
                    <i class="bi bi-calculator"></i> Ver Rentabilidad
                </button>
            </div>
            <div id="profitData" class="mt-3 small text-muted" style="display:none;"></div>
            {% else %}
            <p class="text-muted mb-0">Sin estado financiero asignado.</p>
            {% endif %}
        </div>
    </div>

    <div class="card mb-4 no-print" id="costsSection">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-cash-stack"></i> Gastos del Pedido</h5>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-jema-primary" onclick="openCostModal()">
                    <i class="bi bi-plus-lg"></i> Agregar gasto
                </button>
                <a href="{% url 'cost_config' %}" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-gear"></i> Configuracion
                </a>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm mb-0" id="costsTable">
                    <thead class="bg-light">
                        <tr>
                            <th>Tipo</th>
                            <th>Descripcion</th>
                            <th>Estado Contable</th>
                            <th class="text-end">Total</th>
                            <th class="text-end">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="costsBody">
                        {% for breakdown in cost_breakdowns %}
                        <tr data-breakdown-id="{{ breakdown.id }}">
                            <td>{{ breakdown.cost_type.name }}</td>
                            <td>
                                <div class="fw-medium">{{ breakdown.description }}</div>
                                {% if breakdown.notes %}<small class="text-muted">{{ breakdown.notes }}</small>{% endif %}
                            </td>
                            <td>
                                {% if breakdown.accounting_status == 'posted' %}
                                <span class="badge bg-success">Registrado</span>
                                {% else %}
                                <span class="badge bg-warning text-dark">Pendiente</span>
                                {% endif %}
                                {% if breakdown.accounting_category %}
                                <div><small class="text-muted">{{ breakdown.accounting_category.name }}</small></div>
                                {% endif %}
                            </td>
                            <td class="text-end fw-bold">${{ breakdown.total|floatformat:0 }}</td>
                            <td class="text-end">
                                {% if breakdown.accounting_status == 'posted' %}
                                    {% if breakdown.accounting_transaction_id %}
                                    <a class="btn btn-sm btn-outline-success" href="{% url 'accounting_transaction_update' breakdown.accounting_transaction_id %}">
                                        <i class="bi bi-box-arrow-up-right"></i>
                                    </a>
                                    {% endif %}
                                {% else %}
                                <button class="btn btn-sm btn-outline-secondary" onclick="openCostModal({{ breakdown.id }})"><i class="bi bi-pencil"></i></button>
                                <button class="btn btn-sm btn-outline-primary" onclick="openPostModal({{ breakdown.id }})"><i class="bi bi-cash-coin"></i></button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteCost({{ breakdown.id }})"><i class="bi bi-trash"></i></button>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr id="noCostsRow"><td colspan="5" class="text-center text-muted py-3">No hay gastos registrados.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="border-top pt-3 mt-3">
                <div class="row g-3 align-items-center">
                    <div class="col-md-4">
                        <label class="form-label fw-bold mb-0"><i class="bi bi-truck"></i> Costo de Envio</label>
                    </div>
                    <div class="col-md-2">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text">$</span>
                            <input type="number" step="1" min="0" class="form-control" id="shippingCostInput" value="{{ order.shipping_cost|floatformat:0 }}" onchange="updateShipping()">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold mb-0 text-danger"><i class="bi bi-percent"></i> Descuento Especial</label>
                    </div>
                    <div class="col-md-2">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text">$</span>
                            <input type="number" step="1" min="0" class="form-control text-danger fw-bold" id="discountInput" value="{{ order.discount_amount|floatformat:0 }}" onchange="updateDiscount()">
                        </div>
                    </div>
                </div>
            </div>

            <div class="border-top pt-3 mt-3" id="costsTotals">
                <div class="d-flex justify-content-between mb-1">
                    <span>Total Ingresos (Items):</span>
                    <span class="fw-bold" id="totalItemsIncome">${{ order.total_items_price|floatformat:0|default:"0" }}</span>
                </div>
                <div class="d-flex justify-content-between mb-1">
                    <span>Total Gastos:</span>
                    <span class="fw-bold text-danger" id="totalProduction">-${{ total_production_cost|floatformat:0|default:"0" }}</span>
                </div>
                <div class="d-flex justify-content-between mb-1">
                    <span>Descuento Especial:</span>
                    <span class="fw-bold text-danger" id="totalDiscount">-${{ order.discount_amount|floatformat:0 }}</span>
                </div>
                <div class="d-flex justify-content-between mb-1 border-top pt-2">
                    <span class="fw-bold">Total Neto (Final):</span>
                    <span class="fw-bold fs-5 text-success" id="totalEstimatedDisplay">${{ order.total_estimated|floatformat:0 }}</span>
                </div>
                
                <div class="mt-3 border-top pt-2">
                    <div class="d-flex justify-content-between mb-1">
                        <span>Costo de Envio (No incluido en neto):</span>
                        <span class="fw-bold" id="totalShipping">${{ order.shipping_cost|floatformat:0|default:"0" }}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="fw-bold">Margen Real (Neto - Envio):</span>
                        <span class="fw-bold {% if margin >= 0 %}text-success{% else %}text-danger{% endif %}" id="marginDisplay">${{ margin|floatformat:0|default:"0" }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="costModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="costModalTitle">Agregar gasto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="costBreakdownId">
                <div class="mb-3">
                    <label class="form-label">Tipo de gasto</label>
                    <select id="costTypeInput" class="form-select">
                        {% for ct in cost_types %}
                        <option value="{{ ct.id }}">{{ ct.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3"><label class="form-label">Descripcion</label><input type="text" class="form-control" id="costDescriptionInput"></div>
                <div class="mb-3"><label class="form-label">Total</label><input type="number" min="0" step="1" class="form-control" id="costTotalInput"></div>
                <div class="mb-3">
                    <label class="form-label">Categoria contable sugerida</label>
                    <select id="costAccountingCategoryInput" class="form-select">
                        <option value="">Sin categoria</option>
                        {% for category in accounting_categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div><label class="form-label">Notas</label><textarea id="costNotesInput" class="form-control" rows="2"></textarea></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button class="btn btn-jema-primary" onclick="saveCost()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="postCostModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Registrar pago en contabilidad</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="postBreakdownId">
                <div class="alert alert-light border mb-3" id="postBreakdownLabel"></div>
                <div class="mb-3">
                    <label class="form-label">Cuenta</label>
                    <select id="postAccountInput" class="form-select">
                        {% for account in accounting_accounts %}
                        <option value="{{ account.id }}">{{ account.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Categoria contable</label>
                    <select id="postCategoryInput" class="form-select">
                        <option value="">Usar categoria del gasto</option>
                        {% for category in accounting_categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3"><label class="form-label">Fecha</label><input type="date" id="postDateInput" class="form-control"></div>
                <div><label class="form-label">Descripcion movimiento</label><input type="text" id="postDescriptionInput" class="form-control"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button class="btn btn-success" onclick="postCostToAccounting()">Registrar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const csrfToken = '{{ csrf_token }}';
const orderId = {{ order.id }};
let costsCache = {};
const costModal = new bootstrap.Modal(document.getElementById('costModal'));
const postCostModal = new bootstrap.Modal(document.getElementById('postCostModal'));
const transactionUrlTemplate = '{% url "accounting_transaction_update" 0 %}';

function currency(value) { return '$' + Math.round(parseFloat(value || 0)).toLocaleString(); }
function accountingUrl(id) { return transactionUrlTemplate.replace('/0/', '/' + id + '/'); }
function escapeHtml(value) {
    return String(value || '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
}
function toDateInputValue(today = new Date()) {
    const offset = today.getTimezoneOffset();
    const adjusted = new Date(today.getTime() - (offset * 60 * 1000));
    return adjusted.toISOString().split('T')[0];
}

function refreshTotals(payload) {
    const totalProduction = document.getElementById('totalProduction');
    if (totalProduction) totalProduction.textContent = '-' + currency(payload.total_costs);
    
    const totalItemsIncome = document.getElementById('totalItemsIncome');
    if (totalItemsIncome) totalItemsIncome.textContent = currency(payload.total_items_income || 0);

    const totalShipping = document.getElementById('totalShipping');
    if (totalShipping) totalShipping.textContent = currency(payload.shipping);

    const totalEstimatedDisplay = document.getElementById('totalEstimatedDisplay');
    if (totalEstimatedDisplay) totalEstimatedDisplay.textContent = currency(payload.sale_total);

    const totalDiscount = document.getElementById('totalDiscount');
    if (totalDiscount) totalDiscount.textContent = '-' + currency(payload.discount_amount || 0);

    const margin = parseFloat(payload.margin || 0);
    const marginEl = document.getElementById('marginDisplay');
    if (marginEl) {
        marginEl.textContent = currency(margin);
        marginEl.className = 'fw-bold ' + (margin >= 0 ? 'text-success' : 'text-danger');
    }
}

function renderCosts(breakdowns) {
    const tbody = document.getElementById('costsBody');
    costsCache = {};
    if (!breakdowns || breakdowns.length === 0) {
        tbody.innerHTML = '<tr id="noCostsRow"><td colspan="5" class="text-center text-muted py-3">No hay gastos registrados.</td></tr>';
        return;
    }
    tbody.innerHTML = '';
    breakdowns.forEach((b) => {
        costsCache[b.id] = b;
        const status = b.accounting_status === 'posted'
            ? '<span class="badge bg-success">Registrado</span>'
            : '<span class="badge bg-warning text-dark">Pendiente</span>';
        const category = b.accounting_category_name ? `<div><small class="text-muted">${escapeHtml(b.accounting_category_name)}</small></div>` : '';
        let actions = '';
        if (b.accounting_status === 'posted') {
            if (b.accounting_transaction_id) {
                actions = `<a class="btn btn-sm btn-outline-success" href="${accountingUrl(b.accounting_transaction_id)}"><i class="bi bi-box-arrow-up-right"></i></a>`;
            }
        } else {
            actions = `<button class="btn btn-sm btn-outline-secondary" onclick="openCostModal(${b.id})"><i class="bi bi-pencil"></i></button>
                       <button class="btn btn-sm btn-outline-primary" onclick="openPostModal(${b.id})"><i class="bi bi-cash-coin"></i></button>
                       <button class="btn btn-sm btn-outline-danger" onclick="deleteCost(${b.id})"><i class="bi bi-trash"></i></button>`;
        }
        const notes = b.notes ? `<small class="text-muted">${escapeHtml(b.notes)}</small>` : '';
        tbody.innerHTML += `<tr data-breakdown-id="${b.id}"><td>${escapeHtml(b.cost_type_name)}</td><td><div class="fw-medium">${escapeHtml(b.description)}</div>${notes}</td><td>${status}${category}</td><td class="text-end fw-bold">${currency(b.total)}</td><td class="text-end">${actions}</td></tr>`;
    });
}

function fetchCosts() {
    fetch('{% url "api_get_order_costs" %}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
        body: JSON.stringify({order_type: 'internal', order_id: orderId})
    }).then((r) => r.json()).then((res) => {
        if (!res.ok) { alert(res.error || 'No se pudieron cargar los costos'); return; }
        renderCosts(res.breakdowns || []);
        refreshTotals(res);
    }).catch(() => alert('Error de conexion al cargar costos'));
}

function openCostModal(breakdownId = null) {
    document.getElementById('costBreakdownId').value = breakdownId || '';
    if (!breakdownId) {
        document.getElementById('costModalTitle').textContent = 'Agregar gasto';
        document.getElementById('costDescriptionInput').value = '';
        document.getElementById('costTotalInput').value = '';
        document.getElementById('costNotesInput').value = '';
        document.getElementById('costAccountingCategoryInput').value = '';
    } else {
        const b = costsCache[breakdownId];
        if (!b) return;
        document.getElementById('costModalTitle').textContent = 'Editar gasto';
        document.getElementById('costTypeInput').value = b.cost_type_id;
        document.getElementById('costDescriptionInput').value = b.description;
        document.getElementById('costTotalInput').value = parseFloat(b.total || 0);
        document.getElementById('costNotesInput').value = b.notes || '';
        document.getElementById('costAccountingCategoryInput').value = b.accounting_category_id || '';
    }
    costModal.show();
}

function saveCost() {
    const breakdownId = document.getElementById('costBreakdownId').value;
    const payload = {
        order_type: 'internal',
        order_id: orderId,
        cost_type_id: document.getElementById('costTypeInput').value,
        description: document.getElementById('costDescriptionInput').value,
        total: document.getElementById('costTotalInput').value || 0,
        notes: document.getElementById('costNotesInput').value,
        accounting_category_id: document.getElementById('costAccountingCategoryInput').value || null
    };
    const url = breakdownId ? '{% url "api_update_order_cost" %}' : '{% url "api_create_order_cost" %}';
    if (breakdownId) payload.breakdown_id = parseInt(breakdownId, 10);
    fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
        body: JSON.stringify(payload)
    }).then((r) => r.json()).then((res) => {
        if (!res.ok) { alert(res.error || 'No se pudo guardar el gasto'); return; }
        costModal.hide();
        fetchCosts();
    }).catch(() => alert('Error de conexion al guardar gasto'));
}

function deleteCost(breakdownId) {
    if (!confirm('Eliminar este gasto del pedido?')) return;
    fetch('{% url "api_delete_order_cost" %}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
        body: JSON.stringify({breakdown_id: breakdownId})
    }).then((r) => r.json()).then((res) => {
        if (!res.ok) { alert(res.error || 'No se pudo eliminar el gasto'); return; }
        fetchCosts();
    }).catch(() => alert('Error de conexion al eliminar gasto'));
}

function openPostModal(breakdownId) {
    document.getElementById('postBreakdownId').value = breakdownId;
    document.getElementById('postBreakdownLabel').textContent = costsCache[breakdownId]?.description || 'Gasto';
    document.getElementById('postCategoryInput').value = '';
    document.getElementById('postDescriptionInput').value = '';
    document.getElementById('postDateInput').value = toDateInputValue();
    postCostModal.show();
}

function postCostToAccounting() {
    const breakdownId = document.getElementById('postBreakdownId').value;
    const payload = {
        breakdown_id: parseInt(breakdownId, 10),
        account_id: document.getElementById('postAccountInput').value,
        category_id: document.getElementById('postCategoryInput').value || null,
        date: document.getElementById('postDateInput').value,
        description: document.getElementById('postDescriptionInput').value
    };
    fetch('{% url "api_post_order_cost_to_accounting" %}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
        body: JSON.stringify(payload)
    }).then((r) => r.json()).then((res) => {
        if (!res.ok) { alert(res.error || 'No se pudo registrar el gasto en contabilidad'); return; }
        postCostModal.hide();
        fetchCosts();
    }).catch(() => alert('Error de conexion al registrar en contabilidad'));
}

function updateShipping() {
    const val = document.getElementById('shippingCostInput').value || 0;
    fetch('{% url "api_update_shipping" %}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
        body: JSON.stringify({order_type: 'internal', order_id: orderId, shipping_cost: val})
    }).then((r) => r.json()).then((res) => {
        if (!res.ok) { alert(res.error || 'No se pudo actualizar envio'); return; }
        fetchCosts();
    }).catch(() => alert('Error de conexion al actualizar envio'));
}

function updateDiscount() {
    const val = document.getElementById('discountInput').value || 0;
    fetch('{% url "api_update_discount" %}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
        body: JSON.stringify({order_type: 'internal', order_id: orderId, discount_amount: val})
    }).then((r) => r.json()).then((res) => {
        if (!res.ok) { alert(res.error || 'No se pudo actualizar descuento'); return; }
        document.getElementById('totalDiscount').textContent = '-$' + parseInt(val || 0, 10).toLocaleString();
        fetchCosts();
    }).catch(() => alert('Error de conexion al actualizar descuento'));
}

function transitionFinancialState(fsId, newState) {
    const labels = {enviado: 'Enviado', cobrado: 'Cobrado', cancelado: 'Cancelado'};
    if (!confirm('Cambiar estado financiero a ' + labels[newState] + '?')) return;
    fetch('{% url "api_jc_transition" %}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
        body: JSON.stringify({financial_status_id: fsId, new_state: newState})
    }).then((r) => r.json()).then((res) => {
        if (res.ok) location.reload();
        else alert(res.message || 'Error');
    }).catch(() => alert('Error de conexion'));
}

function loadProfitability(fsId) {
    fetch('{% url "api_jc_profitability" %}?financial_status_id=' + fsId)
    .then((r) => r.json())
    .then((res) => {
        if (!res.ok) { alert(res.error); return; }
        const el = document.getElementById('profitData');
        const profit = parseFloat(res.net_profit);
        const cls = profit >= 0 ? 'text-success' : 'text-danger';
        el.style.display = 'block';
        el.innerHTML = `
            <div class="d-flex justify-content-between mb-1"><small>Venta:</small><small class="fw-bold">$${parseInt(res.sale_amount, 10).toLocaleString()}</small></div>
            <div class="d-flex justify-content-between mb-1"><small>Costos:</small><small class="text-danger">-$${parseInt(res.direct_costs, 10).toLocaleString()}</small></div>
            <div class="d-flex justify-content-between mb-1"><small>Envio:</small><small>-$${parseInt(res.shipping_cost, 10).toLocaleString()}</small></div>
            <div class="d-flex justify-content-between mb-1"><small>Overhead (${parseFloat(res.overhead_percentage).toFixed(2)}%):</small><small class="text-warning">-$${parseInt(res.overhead_amount, 10).toLocaleString()}</small></div>
            <div class="d-flex justify-content-between border-top pt-1 mt-1"><small class="fw-bold">Utilidad:</small><small class="fw-bold ${cls}">$${parseInt(res.net_profit, 10).toLocaleString()}</small></div>
        `;
    })
    .catch(() => alert('Error de conexion'));
}

fetchCosts();
</script>
{% endblock %}
