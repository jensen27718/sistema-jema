{% extends 'base_admin.html' %}

{% block title %}Editor de Pedido - {{ order.name }}{% endblock %}
{% block page_title %}Editor de Pedido{% endblock %}

{% block extra_css %}
<style>
    /* === LAYOUT PRINCIPAL === */
    .order-editor {
        display: grid;
        grid-template-columns: 1fr 380px;
        gap: 20px;
        min-height: calc(100vh - 200px);
    }

    @media (max-width: 1200px) {
        .order-editor {
            grid-template-columns: 1fr;
        }
    }

    /* === PANEL IZQUIERDO: SELECTOR === */
    .selector-panel {
        background: var(--card-bg);
        border-radius: 16px;
        padding: 20px;
        box-shadow: var(--shadow-md);
        position: relative;
    }

    .filter-section {
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border);
    }

    .filter-section:last-of-type {
        border-bottom: none;
    }

    .filter-row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .filter-chip {
        padding: 6px 14px;
        border-radius: 20px;
        background: var(--muted);
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 12px;
        font-weight: 500;
        user-select: none;
    }

    .filter-chip:hover {
        background: var(--jema-purple-light);
        color: white;
    }

    .filter-chip.active {
        background: var(--jema-purple);
        color: white;
        border-color: var(--jema-purple-dark);
    }

    /* === GRID DE VARIANTES === */
    .variants-container {
        margin-top: 16px;
    }

    .variants-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
        gap: 10px;
        max-height: 450px;
        overflow-y: auto;
        padding: 8px;
        background: var(--muted);
        border-radius: 12px;
    }

    .variant-card {
        background: white;
        border-radius: 10px;
        padding: 10px;
        box-shadow: var(--shadow-sm);
        cursor: grab;
        transition: all 0.2s;
        border: 2px solid transparent;
        position: relative;
    }

    .variant-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
        border-color: var(--jema-purple);
    }

    .variant-card.dragging {
        opacity: 0.5;
        transform: rotate(2deg) scale(1.02);
        cursor: grabbing;
    }

    .variant-card img {
        width: 100%;
        height: 70px;
        object-fit: cover;
        border-radius: 6px;
        margin-bottom: 6px;
        background: var(--muted);
    }

    .variant-card .name {
        font-size: 10px;
        font-weight: 600;
        color: var(--foreground);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.3;
    }

    .variant-card .details {
        font-size: 9px;
        color: var(--muted-foreground);
        display: flex;
        align-items: center;
        gap: 4px;
        margin-top: 2px;
    }

    .variant-card .price {
        font-size: 11px;
        font-weight: 700;
        color: var(--jema-teal);
        margin-top: 4px;
    }

    .color-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        border: 1px solid rgba(0,0,0,0.1);
        flex-shrink: 0;
    }

    .variant-card .add-btn {
        position: absolute;
        top: 6px;
        right: 6px;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: var(--jema-teal);
        color: white;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        opacity: 0;
        transition: opacity 0.2s;
    }

    .variant-card:hover .add-btn {
        opacity: 1;
    }

    /* === PANEL DERECHO: PEDIDO === */
    .order-panel {
        background: var(--card-bg);
        border-radius: 16px;
        padding: 20px;
        box-shadow: var(--shadow-md);
        display: flex;
        flex-direction: column;
        height: fit-content;
        position: sticky;
        top: 100px;
        max-height: calc(100vh - 140px);
    }

    @media (max-width: 1200px) {
        .order-panel {
            position: relative;
            top: 0;
            max-height: none;
        }
    }

    .order-header {
        padding-bottom: 12px;
        border-bottom: 2px solid var(--jema-purple);
        margin-bottom: 12px;
    }

    .order-header h4 {
        margin: 0;
        color: var(--jema-purple);
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .order-name-input {
        border: none;
        background: transparent;
        font-size: 16px;
        font-weight: 700;
        color: var(--jema-purple);
        width: 100%;
        outline: none;
    }

    .order-name-input:focus {
        background: var(--muted);
        border-radius: 6px;
        padding: 4px 8px;
        margin: -4px -8px;
    }

    .order-drop-zone {
        flex: 1;
        min-height: 250px;
        max-height: 400px;
        border: 3px dashed var(--border);
        border-radius: 12px;
        padding: 12px;
        transition: all 0.3s;
        overflow-y: auto;
    }

    .order-drop-zone.drag-over {
        border-color: var(--jema-purple);
        background: rgba(107, 45, 123, 0.05);
        border-style: solid;
    }

    .order-drop-zone.empty {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .drop-hint {
        text-align: center;
        color: var(--muted-foreground);
        padding: 20px;
    }

    .drop-hint i {
        font-size: 40px;
        color: var(--border);
        margin-bottom: 10px;
        display: block;
    }

    .drop-hint p {
        margin: 0;
        font-size: 13px;
    }

    /* === ITEMS EN EL PEDIDO === */
    .order-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        background: var(--muted);
        border-radius: 10px;
        margin-bottom: 8px;
        transition: all 0.2s;
    }

    .order-item:hover {
        background: #e8e4eb;
    }

    .order-item img {
        width: 45px;
        height: 45px;
        object-fit: cover;
        border-radius: 6px;
        flex-shrink: 0;
    }

    .order-item-info {
        flex: 1;
        min-width: 0;
    }

    .order-item-name {
        font-size: 11px;
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .order-item-details {
        font-size: 9px;
        color: var(--muted-foreground);
    }

    .order-item-price {
        font-size: 10px;
        color: var(--jema-teal);
        font-weight: 600;
    }

    .order-item-qty {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .order-item-qty input {
        width: 45px;
        text-align: center;
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 4px;
        font-size: 12px;
    }

    .order-item-remove {
        color: #dc3545;
        cursor: pointer;
        padding: 6px;
        border-radius: 50%;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .order-item-remove:hover {
        background: #dc3545;
        color: white;
    }

    /* === TOTALES === */
    .order-totals {
        margin-top: auto;
        padding-top: 12px;
        border-top: 2px solid var(--border);
    }

    .total-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 6px;
        font-size: 13px;
    }

    .total-row.grand-total {
        font-size: 16px;
        font-weight: 700;
        color: var(--jema-purple);
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid var(--border);
    }

    /* === MODOS DE SELECCIÓN === */
    .selection-modes {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
    }

    .mode-btn {
        flex: 1;
        padding: 10px 8px;
        border-radius: 10px;
        border: 2px solid var(--border);
        background: white;
        cursor: pointer;
        text-align: center;
        transition: all 0.2s;
        font-size: 12px;
    }

    .mode-btn:hover {
        border-color: var(--jema-purple);
    }

    .mode-btn.active {
        background: var(--jema-purple);
        color: white;
        border-color: var(--jema-purple);
    }

    .mode-btn i {
        font-size: 18px;
        display: block;
        margin-bottom: 4px;
    }

    /* === AUTO SELECT PANEL === */
    .auto-select-panel {
        background: linear-gradient(135deg, rgba(107, 45, 123, 0.05) 0%, rgba(26, 154, 154, 0.05) 100%);
        border-radius: 12px;
        padding: 14px;
        margin-bottom: 16px;
        display: none;
        border: 1px solid var(--jema-purple-light);
    }

    .auto-select-panel.show {
        display: block;
    }

    .auto-select-panel h6 {
        margin: 0 0 8px 0;
        font-size: 13px;
        color: var(--jema-purple);
    }

    .quantity-input {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
    }

    .quantity-input label {
        font-size: 12px;
        font-weight: 500;
    }

    .quantity-input input {
        width: 70px;
        padding: 8px;
        text-align: center;
        font-size: 14px;
        border-radius: 8px;
        border: 2px solid var(--border);
    }

    .quantity-input input:focus {
        border-color: var(--jema-purple);
        outline: none;
    }

    /* === LOADING === */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: none;
        align-items: center;
        justify-content: center;
        border-radius: 16px;
        z-index: 100;
    }

    .loading-overlay.show {
        display: flex;
    }

    .spinner {
        width: 36px;
        height: 36px;
        border: 4px solid var(--border);
        border-top-color: var(--jema-purple);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    /* === EMPTY STATE === */
    .empty-variants {
        text-align: center;
        padding: 40px 20px;
        color: var(--muted-foreground);
    }

    .empty-variants i {
        font-size: 48px;
        margin-bottom: 12px;
        color: var(--border);
    }

    /* === PRICE FILTER === */
    .price-filter-row {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
    }

    .price-filter-row input {
        width: 90px;
        padding: 6px 10px;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 12px;
    }

    .price-filter-row input:focus {
        border-color: var(--jema-purple);
        outline: none;
    }

    /* === STATUS BADGE === */
    .order-status-badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
    }

    /* === ACTION BUTTONS === */
    .action-buttons {
        display: flex;
        gap: 8px;
        margin-top: 12px;
    }

    .action-buttons .btn {
        flex: 1;
        font-size: 12px;
        padding: 10px;
    }

    /* === SEARCH SECTION === */
    .search-section {
        background: linear-gradient(135deg, rgba(107, 45, 123, 0.03) 0%, rgba(26, 154, 154, 0.03) 100%);
        padding: 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
    }

    .search-section .input-group {
        box-shadow: var(--shadow-sm);
        border-radius: 10px;
        overflow: hidden;
    }

    .search-section .input-group-text {
        border: 1px solid var(--border);
        border-right: none;
    }

    .search-section .form-control {
        border: 1px solid var(--border);
        padding: 10px 12px;
        font-size: 14px;
    }

    .search-section .form-control:focus {
        border-color: var(--jema-purple);
        box-shadow: none;
    }

    .search-section .form-control::placeholder {
        color: var(--muted-foreground);
        font-size: 13px;
    }

    .search-section .btn {
        border-radius: 0;
    }

    .search-section .btn:last-child {
        border-top-right-radius: 10px;
        border-bottom-right-radius: 10px;
    }

    .search-highlight {
        background: rgba(233, 30, 140, 0.2);
        padding: 2px 4px;
        border-radius: 3px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Encabezado -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <div>
            <a href="{% url 'internal_orders_list' %}" class="text-muted text-decoration-none mb-2 d-inline-block">
                <i class="bi bi-arrow-left"></i> Volver a pedidos
            </a>
            <h5 class="mb-0">
                <i class="bi bi-box-seam text-jema-purple"></i>
                Pedido #{{ order.id }}
                <span class="badge bg-{{ order.get_status_color }} order-status-badge ms-2">
                    {{ order.get_status_display }}
                </span>
            </h5>
        </div>
        <div class="d-flex gap-2">
            {% if order.status == 'draft' %}
            <form action="{% url 'internal_order_confirm' order.id %}" method="post" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-success">
                    <i class="bi bi-check-lg"></i> Confirmar
                </button>
            </form>
            {% endif %}
            <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="bi bi-gear"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="#" onclick="clearOrder()"><i class="bi bi-trash me-2"></i>Vaciar pedido</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="{% url 'internal_order_delete' order.id %}"><i class="bi bi-x-circle me-2"></i>Eliminar pedido</a></li>
                </ul>
            </div>
        </div>
    </div>

    <div class="order-editor">
        <!-- Panel Izquierdo: Selector de Variantes -->
        <div class="selector-panel">
            <div class="loading-overlay" id="loadingOverlay">
                <div class="spinner"></div>
            </div>

            <!-- Modos de Selección -->
            <div class="selection-modes">
                <button class="mode-btn active" data-mode="manual" onclick="setMode('manual')">
                    <i class="bi bi-hand-index"></i>
                    Manual
                </button>
                <button class="mode-btn" data-mode="auto" onclick="setMode('auto')">
                    <i class="bi bi-magic"></i>
                    Semi-Auto
                </button>
                <button class="mode-btn" data-mode="price" onclick="setMode('price')">
                    <i class="bi bi-currency-dollar"></i>
                    Por Precio
                </button>
            </div>

            <!-- Panel Auto-Select -->
            <div class="auto-select-panel" id="autoSelectPanel">
                <h6><i class="bi bi-magic"></i> Selección Semi-Automática</h6>
                <p class="text-muted small mb-2">El sistema elegirá referencias aleatorias según tus filtros</p>
                <div class="quantity-input">
                    <label>Cantidad:</label>
                    <input type="number" id="autoQuantity" value="10" min="1" max="100">
                    <button class="btn btn-jema-primary btn-sm" onclick="autoSelect()">
                        <i class="bi bi-shuffle"></i> Generar
                    </button>
                </div>
            </div>

            <!-- Barra de Búsqueda -->
            <div class="search-section mb-3">
                <div class="input-group">
                    <span class="input-group-text bg-white border-end-0">
                        <i class="bi bi-search text-muted"></i>
                    </span>
                    <input type="text"
                           class="form-control border-start-0 ps-0"
                           id="searchInput"
                           placeholder="Buscar por referencia o descripción..."
                           onkeyup="handleSearchKeyup(event)">
                    <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()" id="clearSearchBtn" style="display: none;">
                        <i class="bi bi-x-lg"></i>
                    </button>
                    <button class="btn btn-jema-primary" type="button" onclick="applyFilters()">
                        Buscar
                    </button>
                </div>
                <small class="text-muted mt-1 d-block">Presiona Enter para buscar o usa los filtros</small>
            </div>

            <!-- Filtros -->
            <div class="filter-section">
                <h6 class="mb-2" style="font-size: 12px;"><i class="bi bi-funnel"></i> Tipo de Producto</h6>
                <div class="filter-row">
                    <span class="filter-chip active" data-filter="product_type" data-value="">Todos</span>
                    {% for code, name in product_types %}
                    <span class="filter-chip" data-filter="product_type" data-value="{{ code }}">{{ name }}</span>
                    {% endfor %}
                </div>
            </div>

            <div class="filter-section">
                <h6 class="mb-2" style="font-size: 12px;"><i class="bi bi-folder"></i> Categoría</h6>
                <div class="filter-row">
                    <span class="filter-chip active" data-filter="category_id" data-value="">Todas</span>
                    {% for cat in categories %}
                    <span class="filter-chip" data-filter="category_id" data-value="{{ cat.id }}">{{ cat.name }}</span>
                    {% endfor %}
                </div>
            </div>

            <div class="filter-section">
                <h6 class="mb-2" style="font-size: 12px;"><i class="bi bi-layers"></i> Material</h6>
                <div class="filter-row">
                    <span class="filter-chip active" data-filter="material_id" data-value="">Todos</span>
                    {% for mat in materials %}
                    <span class="filter-chip" data-filter="material_id" data-value="{{ mat.id }}">{{ mat.name }}</span>
                    {% endfor %}
                </div>
            </div>

            <div class="filter-section">
                <h6 class="mb-2" style="font-size: 12px;"><i class="bi bi-rulers"></i> Tamaño</h6>
                <div class="filter-row">
                    <span class="filter-chip active" data-filter="size_id" data-value="">Todos</span>
                    {% for size in sizes %}
                    <span class="filter-chip" data-filter="size_id" data-value="{{ size.id }}">{{ size.name }}</span>
                    {% endfor %}
                </div>
            </div>

            <!-- Filtro de Precio (Solo modo precio) -->
            <div class="filter-section" id="priceFilter" style="display: none;">
                <h6 class="mb-2" style="font-size: 12px;"><i class="bi bi-cash"></i> Rango de Precio</h6>
                <div class="price-filter-row">
                    <input type="number" id="minPrice" placeholder="Mín $">
                    <span>-</span>
                    <input type="number" id="maxPrice" placeholder="Máx $">
                    <button class="btn btn-sm btn-outline-primary" onclick="applyFilters()">Aplicar</button>
                </div>
            </div>

            <!-- Grid de Variantes -->
            <div class="variants-container">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0" style="font-size: 12px;">
                        <i class="bi bi-grid"></i> Referencias
                        <span id="variantCount" class="badge bg-secondary ms-1">0</span>
                    </h6>
                    <small class="text-muted">Arrastra o haz doble clic para agregar</small>
                </div>
                <div class="variants-grid" id="variantsGrid">
                    <div class="empty-variants" style="grid-column: 1/-1;">
                        <i class="bi bi-arrow-up-circle"></i>
                        <p>Selecciona filtros para ver referencias</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel Derecho: Pedido Actual -->
        <div class="order-panel">
            <div class="order-header">
                <h4>
                    <i class="bi bi-cart3"></i>
                    <input type="text"
                           class="order-name-input"
                           id="orderNameInput"
                           value="{{ order.name }}"
                           onchange="updateOrderName(this.value)"
                           placeholder="Nombre del pedido">
                </h4>
                <small class="text-muted">Arrastra referencias aquí o haz doble clic</small>
            </div>

            <div class="order-drop-zone {% if not order_items %}empty{% endif %}"
                id="orderDropZone"
                ondragover="handleDragOver(event)"
                ondragleave="handleDragLeave(event)"
                ondrop="handleDrop(event)">

                {% if order_items %}
                <div id="orderItemsContainer">
                    {% for item in order_items %}
                    <div class="order-item" data-item-id="{{ item.id }}">
                        {% if item.variant.product.image %}
                        <img src="{{ item.variant.product.image.url }}" alt="">
                        {% else %}
                        <img src="https://via.placeholder.com/45x45?text=IMG" alt="">
                        {% endif %}
                        <div class="order-item-info">
                            <div class="order-item-name">{{ item.product_name }}</div>
                            <div class="order-item-details">{{ item.variant_details }}</div>
                            <div class="order-item-price">${{ item.unit_price|floatformat:0 }}</div>
                        </div>
                        <div class="order-item-qty">
                            <input type="number"
                                   value="{{ item.quantity }}"
                                   min="1"
                                   onchange="updateQuantity({{ item.id }}, this.value)">
                        </div>
                        <span class="order-item-remove" onclick="removeItem({{ item.id }})">
                            <i class="bi bi-trash"></i>
                        </span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="drop-hint" id="dropHint">
                    <i class="bi bi-box-arrow-in-down"></i>
                    <p>Arrastra referencias aquí<br>o usa selección automática</p>
                </div>
                {% endif %}
            </div>

            <div class="order-totals">
                <div class="total-row">
                    <span>Total referencias:</span>
                    <span id="totalItems">{{ order.total_items }}</span>
                </div>
                <div class="total-row grand-total">
                    <span>Estimado:</span>
                    <span id="totalEstimated">${{ order.total_estimated|floatformat:0 }}</span>
                </div>
            </div>

            <div class="action-buttons">
                {% if order.status == 'draft' %}
                <form action="{% url 'internal_order_confirm' order.id %}" method="post" style="flex: 1;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success w-100">
                        <i class="bi bi-check-circle"></i> Confirmar Pedido
                    </button>
                </form>
                {% else %}
                <a href="{% url 'internal_order_detail' order.id %}" class="btn btn-jema-secondary w-100">
                    <i class="bi bi-eye"></i> Ver Detalle
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const ORDER_ID = {{ order.id }};
    const CSRF_TOKEN = '{{ csrf_token }}';

    // Estado de filtros
    let currentFilters = {
        product_type: '',
        category_id: '',
        material_id: '',
        size_id: '',
        min_price: '',
        max_price: '',
        search: ''
    };

    let currentMode = 'manual';
    let searchQuery = '';

    // === MODO DE SELECCIÓN ===
    function setMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.mode === mode);
        });

        // Mostrar/ocultar panels según modo
        document.getElementById('autoSelectPanel').classList.toggle('show', mode === 'auto');
        document.getElementById('priceFilter').style.display = mode === 'price' ? 'block' : 'none';

        applyFilters();
    }

    // === FILTROS ===
    document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.addEventListener('click', function() {
            const filterType = this.dataset.filter;
            const value = this.dataset.value;

            // Toggle active dentro del mismo grupo
            this.closest('.filter-row').querySelectorAll('.filter-chip').forEach(c => {
                c.classList.remove('active');
            });
            this.classList.add('active');

            currentFilters[filterType] = value;
            applyFilters();
        });
    });

    // === BÚSQUEDA ===
    function handleSearchKeyup(event) {
        const searchInput = document.getElementById('searchInput');
        const clearBtn = document.getElementById('clearSearchBtn');

        // Mostrar/ocultar botón de limpiar
        clearBtn.style.display = searchInput.value.length > 0 ? 'block' : 'none';

        // Buscar al presionar Enter
        if (event.key === 'Enter') {
            applyFilters();
        }
    }

    function clearSearch() {
        const searchInput = document.getElementById('searchInput');
        const clearBtn = document.getElementById('clearSearchBtn');

        searchInput.value = '';
        clearBtn.style.display = 'none';
        currentFilters.search = '';
        applyFilters();
    }

    async function applyFilters() {
        showLoading(true);

        const filters = { ...currentFilters };

        // Agregar búsqueda
        const searchInput = document.getElementById('searchInput');
        filters.search = searchInput ? searchInput.value.trim() : '';
        currentFilters.search = filters.search;

        if (currentMode === 'price') {
            filters.min_price = document.getElementById('minPrice').value;
            filters.max_price = document.getElementById('maxPrice').value;
        }

        try {
            const response = await fetch('/api/internal-orders/filter-variants/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': CSRF_TOKEN
                },
                body: JSON.stringify(filters)
            });

            const data = await response.json();
            renderVariants(data.items);
            document.getElementById('variantCount').textContent = data.count;
        } catch (error) {
            console.error('Error:', error);
        }

        showLoading(false);
    }

    function renderVariants(items) {
        const grid = document.getElementById('variantsGrid');
        const searchTerm = currentFilters.search;

        if (items.length === 0) {
            let emptyMsg = 'No se encontraron referencias<br>con estos filtros';
            if (searchTerm) {
                emptyMsg = `No se encontraron referencias para<br><strong>"${escapeHtml(searchTerm)}"</strong>`;
            }
            grid.innerHTML = `
                <div class="empty-variants" style="grid-column: 1/-1;">
                    <i class="bi bi-search"></i>
                    <p>${emptyMsg}</p>
                </div>
            `;
            return;
        }

        grid.innerHTML = items.map(item => {
            // Resaltar texto de búsqueda si existe
            let displayName = escapeHtml(item.product_name);
            if (searchTerm) {
                displayName = highlightText(item.product_name, searchTerm);
            }

            return `
            <div class="variant-card"
                 draggable="true"
                 data-variant-id="${item.id}"
                 ondragstart="handleDragStart(event)"
                 ondragend="handleDragEnd(event)"
                 ondblclick="addItemDirect(${item.id})">
                <button class="add-btn" onclick="event.stopPropagation(); addItemDirect(${item.id})">
                    <i class="bi bi-plus"></i>
                </button>
                <img src="${item.product_image || 'https://via.placeholder.com/100x70?text=IMG'}" alt="" onerror="this.src='https://via.placeholder.com/100x70?text=IMG'">
                <div class="name" title="${escapeHtml(item.product_name)}">${displayName}</div>
                <div class="details">
                    ${item.color ? `<span class="color-dot" style="background: ${item.color_hex}"></span>` : ''}
                    <span>${item.size || ''} ${item.material || ''}</span>
                </div>
                <div class="price">$${item.price.toLocaleString('es-CO')}</div>
            </div>
        `}).join('');
    }

    // Función para escapar HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Función para resaltar texto de búsqueda
    function highlightText(text, search) {
        if (!search) return escapeHtml(text);
        const regex = new RegExp(`(${escapeRegex(search)})`, 'gi');
        return escapeHtml(text).replace(regex, '<mark class="search-highlight">$1</mark>');
    }

    // Escapar caracteres especiales de regex
    function escapeRegex(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // === DRAG & DROP ===
    function handleDragStart(e) {
        e.target.classList.add('dragging');
        e.dataTransfer.setData('text/plain', e.target.dataset.variantId);
        e.dataTransfer.effectAllowed = 'copy';
    }

    function handleDragEnd(e) {
        e.target.classList.remove('dragging');
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'copy';
        document.getElementById('orderDropZone').classList.add('drag-over');
    }

    function handleDragLeave(e) {
        if (!e.currentTarget.contains(e.relatedTarget)) {
            document.getElementById('orderDropZone').classList.remove('drag-over');
        }
    }

    async function handleDrop(e) {
        e.preventDefault();
        document.getElementById('orderDropZone').classList.remove('drag-over');

        const variantId = e.dataTransfer.getData('text/plain');
        if (variantId) {
            await addItem(variantId);
        }
    }

    // === AGREGAR/ELIMINAR ITEMS ===
    async function addItem(variantId) {
        try {
            const response = await fetch('/api/internal-orders/add-item/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': CSRF_TOKEN
                },
                body: JSON.stringify({
                    order_id: ORDER_ID,
                    variant_id: variantId,
                    quantity: 1
                })
            });

            const data = await response.json();
            if (data.status === 'ok') {
                updateTotals(data.order_totals.total_items, data.order_totals.total_estimated);

                if (data.is_new) {
                    addItemToUI(data.item);
                } else {
                    // Actualizar cantidad existente
                    const itemEl = document.querySelector(`[data-item-id="${data.item.id}"]`);
                    if (itemEl) {
                        itemEl.querySelector('input').value = data.item.quantity;
                    }
                }
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    function addItemDirect(variantId) {
        addItem(variantId);
    }

    function addItemToUI(item) {
        const dropZone = document.getElementById('orderDropZone');
        const hint = document.getElementById('dropHint');

        // Remover hint si existe
        if (hint) {
            hint.remove();
        }
        dropZone.classList.remove('empty');

        // Crear o obtener el contenedor
        let container = document.getElementById('orderItemsContainer');
        if (!container) {
            container = document.createElement('div');
            container.id = 'orderItemsContainer';
            dropZone.appendChild(container);
        }

        // Agregar item
        const itemHTML = `
            <div class="order-item" data-item-id="${item.id}">
                <img src="${item.image_url || 'https://via.placeholder.com/45x45?text=IMG'}" alt="" onerror="this.src='https://via.placeholder.com/45x45?text=IMG'">
                <div class="order-item-info">
                    <div class="order-item-name">${item.product_name}</div>
                    <div class="order-item-details">${item.variant_details}</div>
                    <div class="order-item-price">$${item.unit_price.toLocaleString('es-CO')}</div>
                </div>
                <div class="order-item-qty">
                    <input type="number" value="${item.quantity}" min="1" onchange="updateQuantity(${item.id}, this.value)">
                </div>
                <span class="order-item-remove" onclick="removeItem(${item.id})">
                    <i class="bi bi-trash"></i>
                </span>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', itemHTML);
    }

    async function removeItem(itemId) {
        if (!confirm('¿Eliminar este item?')) return;

        try {
            const response = await fetch('/api/internal-orders/remove-item/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': CSRF_TOKEN
                },
                body: JSON.stringify({ item_id: itemId })
            });

            const data = await response.json();
            if (data.status === 'ok') {
                const itemEl = document.querySelector(`[data-item-id="${itemId}"]`);
                if (itemEl) {
                    itemEl.remove();
                }
                updateTotals(data.order_totals.total_items, data.order_totals.total_estimated);

                // Mostrar hint si está vacío
                const container = document.getElementById('orderItemsContainer');
                if (!container || !container.children.length) {
                    showEmptyHint();
                }
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    function showEmptyHint() {
        const dropZone = document.getElementById('orderDropZone');
        const container = document.getElementById('orderItemsContainer');
        if (container) container.remove();

        dropZone.classList.add('empty');
        dropZone.innerHTML = `
            <div class="drop-hint" id="dropHint">
                <i class="bi bi-box-arrow-in-down"></i>
                <p>Arrastra referencias aquí<br>o usa selección automática</p>
            </div>
        `;
    }

    // === SELECCIÓN AUTOMÁTICA ===
    async function autoSelect() {
        const quantity = document.getElementById('autoQuantity').value;
        showLoading(true);

        try {
            const response = await fetch('/api/internal-orders/auto-select/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': CSRF_TOKEN
                },
                body: JSON.stringify({
                    order_id: ORDER_ID,
                    quantity: parseInt(quantity),
                    ...currentFilters
                })
            });

            const data = await response.json();
            if (data.status === 'ok') {
                // Agregar items a la UI
                data.added_items.forEach(item => {
                    addItemToUI(item);
                });
                updateTotals(data.order_totals.total_items, data.order_totals.total_estimated);
                alert(`Se agregaron ${data.added_count} referencias al pedido`);
            }
        } catch (error) {
            console.error('Error:', error);
        }

        showLoading(false);
    }

    // === ACTUALIZAR CANTIDAD ===
    async function updateQuantity(itemId, newQty) {
        try {
            const response = await fetch('/api/internal-orders/update-quantity/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': CSRF_TOKEN
                },
                body: JSON.stringify({
                    item_id: itemId,
                    quantity: parseInt(newQty)
                })
            });

            const data = await response.json();
            if (data.status === 'ok') {
                updateTotals(data.order_totals.total_items, data.order_totals.total_estimated);
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // === ACTUALIZAR NOMBRE DEL PEDIDO ===
    async function updateOrderName(name) {
        try {
            await fetch('/api/internal-orders/update-info/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': CSRF_TOKEN
                },
                body: JSON.stringify({
                    order_id: ORDER_ID,
                    name: name
                })
            });
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // === VACIAR PEDIDO ===
    async function clearOrder() {
        if (!confirm('¿Estás seguro de vaciar todo el pedido?')) return;

        try {
            const response = await fetch('/api/internal-orders/clear/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': CSRF_TOKEN
                },
                body: JSON.stringify({ order_id: ORDER_ID })
            });

            const data = await response.json();
            if (data.status === 'ok') {
                showEmptyHint();
                updateTotals(0, 0);
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // === HELPERS ===
    function updateTotals(items, estimated) {
        document.getElementById('totalItems').textContent = items;
        document.getElementById('totalEstimated').textContent = '$' + estimated.toLocaleString('es-CO');
    }

    function showLoading(show) {
        document.getElementById('loadingOverlay').classList.toggle('show', show);
    }

    // Cargar variantes al iniciar
    document.addEventListener('DOMContentLoaded', applyFilters);
</script>
{% endblock %}
