{% extends 'base_admin.html' %}

{% block title %}Editor de Pedido - {{ order.name }}{% endblock %}
{% block page_title %}Editor de Pedido{% endblock %}

{% block extra_css %}
<style>
    /* === LAYOUT PRINCIPAL 3 COLUMNAS === */
    .order-editor-wrapper {
        display: flex;
        gap: 16px;
        min-height: calc(100vh - 200px);
    }

    /* Columna Izquierda: Filtros/Variaciones */
    .filters-column {
        width: 280px;
        flex-shrink: 0;
        background: var(--card-bg);
        border-radius: 16px;
        padding: 16px;
        box-shadow: var(--shadow-md);
        height: fit-content;
        position: sticky;
        top: 100px;
        max-height: calc(100vh - 140px);
        overflow-y: auto;
    }

    /* Columna Central: Referencias */
    .references-column {
        flex: 1;
        min-width: 0;
        background: var(--card-bg);
        border-radius: 16px;
        padding: 16px;
        box-shadow: var(--shadow-md);
    }

    /* Columna Derecha: Carrito */
    .cart-column {
        width: 340px;
        flex-shrink: 0;
        background: var(--card-bg);
        border-radius: 16px;
        padding: 16px;
        box-shadow: var(--shadow-md);
        display: flex;
        flex-direction: column;
        height: fit-content;
        position: sticky;
        top: 100px;
        max-height: calc(100vh - 140px);
    }

    @media (max-width: 1400px) {
        .filters-column {
            width: 240px;
        }
        .cart-column {
            width: 300px;
        }
    }

    @media (max-width: 1100px) {
        .order-editor-wrapper {
            flex-direction: column;
        }
        .filters-column, .cart-column {
            width: 100%;
            position: relative;
            top: 0;
            max-height: none;
        }
    }

    /* === SECCIONES DE FILTROS === */
    .filter-section {
        margin-bottom: 14px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border);
    }

    .filter-section:last-of-type {
        border-bottom: none;
    }

    .filter-section h6 {
        font-size: 11px;
        font-weight: 700;
        color: var(--muted-foreground);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .filter-row {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
    }

    .filter-chip {
        padding: 5px 12px;
        border-radius: 16px;
        background: var(--muted);
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 11px;
        font-weight: 500;
        user-select: none;
    }

    .filter-chip:hover {
        background: var(--jema-purple-light);
        color: white;
    }

    .filter-chip.active {
        background: var(--jema-purple);
        color: white;
        border-color: var(--jema-purple-dark);
    }

    /* Secciones ocultas por tipo de producto */
    .filter-section.hidden {
        display: none !important;
    }

    /* === MODOS DE SELECCION === */
    .selection-modes {
        display: flex;
        gap: 6px;
        margin-bottom: 14px;
    }

    .mode-btn {
        flex: 1;
        padding: 8px 6px;
        border-radius: 8px;
        border: 2px solid var(--border);
        background: white;
        cursor: pointer;
        text-align: center;
        transition: all 0.2s;
        font-size: 10px;
    }

    .mode-btn:hover {
        border-color: var(--jema-purple);
    }

    .mode-btn.active {
        background: var(--jema-purple);
        color: white;
        border-color: var(--jema-purple);
    }

    .mode-btn i {
        font-size: 16px;
        display: block;
        margin-bottom: 2px;
    }

    /* === AUTO SELECT PANEL === */
    .auto-select-panel {
        background: linear-gradient(135deg, rgba(107, 45, 123, 0.05) 0%, rgba(26, 154, 154, 0.05) 100%);
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 14px;
        display: none;
        border: 1px solid var(--jema-purple-light);
    }

    .auto-select-panel.show {
        display: block;
    }

    .auto-select-panel h6 {
        margin: 0 0 6px 0;
        font-size: 12px;
        color: var(--jema-purple);
    }

    .quantity-input {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }

    .quantity-input label {
        font-size: 11px;
        font-weight: 500;
    }

    .quantity-input input {
        width: 60px;
        padding: 6px;
        text-align: center;
        font-size: 13px;
        border-radius: 6px;
        border: 2px solid var(--border);
    }

    .quantity-input input:focus {
        border-color: var(--jema-purple);
        outline: none;
    }

    /* === FILTRO DE PRECIO === */
    .price-filter-row {
        display: flex;
        gap: 6px;
        align-items: center;
        flex-wrap: wrap;
    }

    .price-filter-row input {
        width: 75px;
        padding: 5px 8px;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 11px;
    }

    .price-filter-row input:focus {
        border-color: var(--jema-purple);
        outline: none;
    }

    /* === BUSQUEDA === */
    .search-section {
        background: linear-gradient(135deg, rgba(107, 45, 123, 0.03) 0%, rgba(26, 154, 154, 0.03) 100%);
        padding: 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
        margin-bottom: 14px;
    }

    .search-section .input-group {
        box-shadow: var(--shadow-sm);
        border-radius: 10px;
        overflow: hidden;
    }

    .search-section .form-control {
        border: 1px solid var(--border);
        padding: 10px 12px;
        font-size: 14px;
    }

    .search-section .form-control:focus {
        border-color: var(--jema-purple);
        box-shadow: none;
    }

    .search-highlight {
        background: rgba(233, 30, 140, 0.2);
        padding: 2px 4px;
        border-radius: 3px;
    }

    /* === GRID DE VARIANTES === */
    .variants-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 10px;
        max-height: calc(100vh - 320px);
        overflow-y: auto;
        padding: 8px;
        background: var(--muted);
        border-radius: 12px;
    }

    .variant-card {
        background: white;
        border-radius: 10px;
        padding: 10px;
        box-shadow: var(--shadow-sm);
        cursor: grab;
        transition: all 0.2s;
        border: 2px solid transparent;
        position: relative;
    }

    .variant-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
        border-color: var(--jema-purple);
    }

    .variant-card.dragging {
        opacity: 0.5;
        transform: rotate(2deg) scale(1.02);
        cursor: grabbing;
    }

    .variant-card img {
        width: 100%;
        height: 80px;
        object-fit: cover;
        border-radius: 6px;
        margin-bottom: 6px;
        background: var(--muted);
    }

    .variant-card .name {
        font-size: 10px;
        font-weight: 600;
        color: var(--foreground);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.3;
    }

    .variant-card .details {
        font-size: 9px;
        color: var(--muted-foreground);
        display: flex;
        align-items: center;
        gap: 4px;
        margin-top: 2px;
    }

    .variant-card .price {
        font-size: 11px;
        font-weight: 700;
        color: var(--jema-teal);
        margin-top: 4px;
    }

    .color-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        border: 1px solid rgba(0,0,0,0.1);
        flex-shrink: 0;
    }

    .variant-card .add-btn {
        position: absolute;
        top: 6px;
        right: 6px;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: var(--jema-teal);
        color: white;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        opacity: 0;
        transition: opacity 0.2s;
    }

    .variant-card:hover .add-btn {
        opacity: 1;
    }

    /* === CARRITO / PEDIDO === */
    .cart-header {
        padding-bottom: 10px;
        border-bottom: 2px solid var(--jema-purple);
        margin-bottom: 10px;
    }

    .cart-header h4 {
        margin: 0;
        color: var(--jema-purple);
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .order-name-input {
        border: none;
        background: transparent;
        font-size: 14px;
        font-weight: 700;
        color: var(--jema-purple);
        width: 100%;
        outline: none;
    }

    .order-name-input:focus {
        background: var(--muted);
        border-radius: 6px;
        padding: 4px 8px;
        margin: -4px -8px;
    }

    .cart-drop-zone {
        flex: 1;
        min-height: 200px;
        max-height: 350px;
        border: 3px dashed var(--border);
        border-radius: 12px;
        padding: 10px;
        transition: all 0.3s;
        overflow-y: auto;
    }

    .cart-drop-zone.drag-over {
        border-color: var(--jema-purple);
        background: rgba(107, 45, 123, 0.05);
        border-style: solid;
    }

    .cart-drop-zone.empty {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .drop-hint {
        text-align: center;
        color: var(--muted-foreground);
        padding: 20px;
    }

    .drop-hint i {
        font-size: 36px;
        color: var(--border);
        margin-bottom: 10px;
        display: block;
    }

    .drop-hint p {
        margin: 0;
        font-size: 12px;
    }

    /* === ITEMS EN EL CARRITO === */
    .cart-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px;
        background: var(--muted);
        border-radius: 8px;
        margin-bottom: 6px;
        transition: all 0.2s;
    }

    .cart-item:hover {
        background: #e8e4eb;
    }

    .cart-item img {
        width: 40px;
        height: 40px;
        object-fit: cover;
        border-radius: 6px;
        flex-shrink: 0;
    }

    .cart-item-info {
        flex: 1;
        min-width: 0;
    }

    .cart-item-name {
        font-size: 10px;
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .cart-item-details {
        font-size: 9px;
        color: var(--muted-foreground);
    }

    .cart-item-price {
        font-size: 10px;
        color: var(--jema-teal);
        font-weight: 600;
    }

    .cart-item-qty {
        display: flex;
        align-items: center;
        gap: 2px;
        flex-shrink: 0;
    }

    .cart-item-qty input {
        width: 40px;
        text-align: center;
        border: 1px solid var(--border);
        border-radius: 4px;
        padding: 3px;
        font-size: 11px;
    }

    .cart-item-remove {
        color: #dc3545;
        cursor: pointer;
        padding: 4px;
        border-radius: 50%;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .cart-item-remove:hover {
        background: #dc3545;
        color: white;
    }

    /* === TOTALES === */
    .cart-totals {
        margin-top: auto;
        padding-top: 10px;
        border-top: 2px solid var(--border);
    }

    .total-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 4px;
        font-size: 12px;
    }

    .total-row.grand-total {
        font-size: 15px;
        font-weight: 700;
        color: var(--jema-purple);
        margin-top: 6px;
        padding-top: 6px;
        border-top: 1px solid var(--border);
    }

    /* === ACTION BUTTONS === */
    .action-buttons {
        display: flex;
        gap: 6px;
        margin-top: 10px;
    }

    .action-buttons .btn {
        flex: 1;
        font-size: 11px;
        padding: 8px;
    }

    /* === EMPTY STATE === */
    .empty-variants {
        text-align: center;
        padding: 30px 20px;
        color: var(--muted-foreground);
        grid-column: 1/-1;
    }

    .empty-variants i {
        font-size: 40px;
        margin-bottom: 10px;
        color: var(--border);
    }

    /* === LOADING === */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: none;
        align-items: center;
        justify-content: center;
        border-radius: 16px;
        z-index: 100;
    }

    .loading-overlay.show {
        display: flex;
    }

    .spinner {
        width: 32px;
        height: 32px;
        border: 4px solid var(--border);
        border-top-color: var(--jema-purple);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    /* === STATUS BADGE === */
    .order-status-badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Encabezado -->
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <div>
            <a href="{% url 'internal_orders_list' %}" class="text-muted text-decoration-none mb-1 d-inline-block small">
                <i class="bi bi-arrow-left"></i> Volver a pedidos
            </a>
            <h5 class="mb-0">
                <i class="bi bi-box-seam text-jema-purple"></i>
                Pedido #{{ order.id }}
                <span class="badge bg-{{ order.get_status_color }} order-status-badge ms-2">
                    {{ order.get_status_display }}
                </span>
            </h5>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-warning btn-sm text-white" onclick="downloadOrderCSV()">
                <i class="bi bi-file-earmark-spreadsheet"></i> CSV
            </button>
            {% if order.status == 'draft' %}
            <form action="{% url 'internal_order_confirm' order.id %}" method="post" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-success btn-sm">
                    <i class="bi bi-check-lg"></i> Confirmar
                </button>
            </form>
            {% endif %}
            <div class="dropdown">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="bi bi-gear"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="#" onclick="clearOrder()"><i class="bi bi-trash me-2"></i>Vaciar pedido</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="{% url 'internal_order_delete' order.id %}"><i class="bi bi-x-circle me-2"></i>Eliminar pedido</a></li>
                </ul>
            </div>
        </div>
    </div>

    <div class="order-editor-wrapper">
        <!-- COLUMNA IZQUIERDA: FILTROS Y VARIACIONES -->
        <div class="filters-column">
            <!-- Modos de Seleccion -->
            <div class="selection-modes">
                <button class="mode-btn active" data-mode="manual" onclick="setMode('manual')">
                    <i class="bi bi-hand-index"></i>
                    Manual
                </button>
                <button class="mode-btn" data-mode="auto" onclick="setMode('auto')">
                    <i class="bi bi-magic"></i>
                    Auto
                </button>
                <button class="mode-btn" data-mode="price" onclick="setMode('price')">
                    <i class="bi bi-cash"></i>
                    Precio
                </button>
            </div>

            <!-- Panel Auto-Select -->
            <div class="auto-select-panel" id="autoSelectPanel">
                <h6><i class="bi bi-magic"></i> Seleccion Automatica</h6>
                <p class="text-muted small mb-2">Genera referencias aleatorias</p>
                <div class="quantity-input">
                    <label>Cantidad:</label>
                    <input type="number" id="autoQuantity" value="10" min="1" max="100">
                    <button class="btn btn-jema-primary btn-sm" onclick="autoSelect()">
                        <i class="bi bi-shuffle"></i> Generar
                    </button>
                </div>
            </div>

            <!-- Tipo de Producto (Estatico) -->
            <div class="filter-section" id="filterProductType">
                <h6><i class="bi bi-funnel"></i> Tipo de Producto</h6>
                <div class="filter-row" id="productTypeChips">
                    <span class="filter-chip active" data-filter="product_type" data-value="">Todos</span>
                    {% for code, name in product_types %}
                    <span class="filter-chip" data-filter="product_type" data-value="{{ code }}">{{ name }}</span>
                    {% endfor %}
                </div>
            </div>

            <!-- Categoria (Dinamico) -->
            <div class="filter-section" id="filterCategory">
                <h6><i class="bi bi-folder"></i> Categoria</h6>
                <div class="filter-row" id="categoryChips">
                    <span class="text-muted small">Cargando...</span>
                </div>
            </div>

            <!-- Material (Dinamico - Se oculta si no aplica) -->
            <div class="filter-section hidden" id="filterMaterial">
                <h6><i class="bi bi-layers"></i> Material</h6>
                <div class="filter-row" id="materialChips">
                    <span class="text-muted small">Cargando...</span>
                </div>
            </div>

            <!-- Tamano (Dinamico - Se oculta si no aplica) -->
            <div class="filter-section hidden" id="filterSize">
                <h6><i class="bi bi-rulers"></i> Tamano</h6>
                <div class="filter-row" id="sizeChips">
                    <span class="text-muted small">Cargando...</span>
                </div>
            </div>

            <!-- Color (Dinamico - Se oculta si no aplica) -->
            <div class="filter-section hidden" id="filterColor">
                <h6><i class="bi bi-palette"></i> Color</h6>
                <div class="filter-row" id="colorChips">
                    <span class="text-muted small">Cargando...</span>
                </div>
            </div>

            <!-- Filtro de Precio (Solo modo precio) -->
            <div class="filter-section" id="priceFilter" style="display: none;">
                <h6><i class="bi bi-cash"></i> Rango de Precio</h6>
                <div class="price-filter-row">
                    <input type="number" id="minPrice" placeholder="Min $">
                    <span>-</span>
                    <input type="number" id="maxPrice" placeholder="Max $">
                    <button class="btn btn-sm btn-outline-primary" onclick="applyFilters()">OK</button>
                </div>
            </div>
        </div>

        <!-- COLUMNA CENTRAL: REFERENCIAS -->
        <div class="references-column">
            <div class="loading-overlay" id="loadingOverlay">
                <div class="spinner"></div>
            </div>

            <!-- Barra de Busqueda -->
            <div class="search-section">
                <div class="input-group">
                    <span class="input-group-text bg-white border-end-0">
                        <i class="bi bi-search text-muted"></i>
                    </span>
                    <input type="text"
                           class="form-control border-start-0 ps-0"
                           id="searchInput"
                           placeholder="Buscar por referencia..."
                           onkeyup="handleSearchKeyup(event)">
                    <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()" id="clearSearchBtn" style="display: none;">
                        <i class="bi bi-x-lg"></i>
                    </button>
                    <button class="btn btn-jema-primary" type="button" onclick="applyFilters()">
                        Buscar
                    </button>
                </div>
            </div>

            <!-- Grid de Referencias -->
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0" style="font-size: 12px;">
                    <i class="bi bi-grid"></i> Referencias
                    <span id="variantCount" class="badge bg-secondary ms-1">0</span>
                </h6>
                <small class="text-muted">Arrastra o doble clic para agregar</small>
            </div>
            <div class="variants-grid" id="variantsGrid">
                <div class="empty-variants">
                    <i class="bi bi-arrow-left-circle"></i>
                    <p>Selecciona filtros para ver referencias</p>
                </div>
            </div>
            <!-- Pagination Controls -->
            <div id="paginationControls" class="d-flex justify-content-center align-items-center mt-2 gap-2" style="display: none !important;">
                <button class="btn btn-sm btn-outline-secondary" onclick="changePage(-1)" id="prevPageBtn" disabled>
                    <i class="bi bi-chevron-left"></i>
                </button>
                <span class="small text-muted" id="pageInfo">Página 1</span>
                <button class="btn btn-sm btn-outline-secondary" onclick="changePage(1)" id="nextPageBtn" disabled>
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>
        </div>

        <!-- COLUMNA DERECHA: CARRITO -->
        <div class="cart-column">
            <div class="cart-header">
                <h4>
                    <i class="bi bi-cart3"></i>
                    <input type="text"
                           class="order-name-input"
                           id="orderNameInput"
                           value="{{ order.name }}"
                           onchange="updateOrderName(this.value)"
                           placeholder="Nombre del pedido">
                </h4>
                <small class="text-muted">Arrastra referencias aqui</small>
            </div>

            <div class="cart-drop-zone {% if not order_items %}empty{% endif %}"
                id="cartDropZone"
                ondragover="handleDragOver(event)"
                ondragleave="handleDragLeave(event)"
                ondrop="handleDrop(event)">

                {% if order_items %}
                <div id="cartItemsContainer">
                    {% for item in order_items %}
                    <div class="cart-item" data-item-id="{{ item.id }}">
                        {% if item.variant.product.image %}
                        <img src="{{ item.variant.product.image.url }}" alt="">
                        {% else %}
                        <img src="https://via.placeholder.com/40x40?text=IMG" alt="">
                        {% endif %}
                        <div class="cart-item-info">
                            <div class="cart-item-name">{{ item.product_name }}</div>
                            <div class="cart-item-details">{{ item.variant_details }}</div>
                            <div class="cart-item-price">${{ item.unit_price|floatformat:0 }}</div>
                        </div>
                        <div class="cart-item-qty">
                            <input type="number"
                                   value="{{ item.quantity }}"
                                   min="1"
                                   onchange="updateQuantity({{ item.id }}, this.value)">
                        </div>
                        <span class="cart-item-remove" onclick="removeItem({{ item.id }})">
                            <i class="bi bi-trash"></i>
                        </span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="drop-hint" id="dropHint">
                    <i class="bi bi-box-arrow-in-down"></i>
                    <p>Arrastra referencias aqui<br>o usa seleccion automatica</p>
                </div>
                {% endif %}
            </div>

            <div class="cart-totals">
                <div class="total-row">
                    <span>Total referencias:</span>
                    <span id="totalItems">{{ order.total_items }}</span>
                </div>
                <div class="total-row grand-total">
                    <span>Estimado:</span>
                    <span id="totalEstimated">${{ order.total_estimated|floatformat:0 }}</span>
                </div>
            </div>

            <div class="action-buttons">
                {% if order.status == 'draft' %}
                <form action="{% url 'internal_order_confirm' order.id %}" method="post" style="flex: 1;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success w-100">
                        <i class="bi bi-check-circle"></i> Confirmar
                    </button>
                </form>
                {% else %}
                <a href="{% url 'internal_order_detail' order.id %}" class="btn btn-jema-secondary w-100">
                    <i class="bi bi-eye"></i> Ver Detalle
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const ORDER_ID = {{ order.id }};
    const CSRF_TOKEN = '{{ csrf_token }}';

    // Estado de filtros
    let currentFilters = {
        product_type: '',
        category_id: '',
        material_id: '',
        size_id: '',
        color_id: '',
        min_price: '',
        max_price: '',
        search: ''
    };

    let currentMode = 'manual';
    let draggedElement = null;

    // === CARGAR FILTROS DINAMICOS DESDE LA API ===
    async function loadAvailableFilters() {
        try {
            const response = await fetch('/api/internal-orders/get-filters/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': CSRF_TOKEN
                },
                body: JSON.stringify({ product_type: currentFilters.product_type })
            });

            const data = await response.json();
            if (data.status === 'ok') {
                renderDynamicFilters(data.filters);
            }
        } catch (error) {
            console.error('Error cargando filtros:', error);
        }
    }

    function renderDynamicFilters(filters) {
        // Renderizar categorias
        const categoryChips = document.getElementById('categoryChips');
        if (filters.categories.length > 0) {
            document.getElementById('filterCategory').classList.remove('hidden');
            categoryChips.innerHTML = `
                <span class="filter-chip active" data-filter="category_id" data-value="">Todas</span>
                ${filters.categories.map(cat =>
                    `<span class="filter-chip" data-filter="category_id" data-value="${cat.id}">${escapeHtml(cat.name)}</span>`
                ).join('')}
            `;
        } else {
            document.getElementById('filterCategory').classList.add('hidden');
            categoryChips.innerHTML = '<span class="text-muted small">Sin categorias</span>';
        }

        // Renderizar materiales
        const materialChips = document.getElementById('materialChips');
        if (filters.has_materials && filters.materials.length > 0) {
            document.getElementById('filterMaterial').classList.remove('hidden');
            materialChips.innerHTML = `
                <span class="filter-chip active" data-filter="material_id" data-value="">Todos</span>
                ${filters.materials.map(mat =>
                    `<span class="filter-chip" data-filter="material_id" data-value="${mat.id}">${escapeHtml(mat.name)}</span>`
                ).join('')}
            `;
        } else {
            document.getElementById('filterMaterial').classList.add('hidden');
            currentFilters.material_id = '';
        }

        // Renderizar tamanos
        const sizeChips = document.getElementById('sizeChips');
        if (filters.has_sizes && filters.sizes.length > 0) {
            document.getElementById('filterSize').classList.remove('hidden');
            sizeChips.innerHTML = `
                <span class="filter-chip active" data-filter="size_id" data-value="">Todos</span>
                ${filters.sizes.map(size =>
                    `<span class="filter-chip" data-filter="size_id" data-value="${size.id}">${escapeHtml(size.name)}</span>`
                ).join('')}
            `;
        } else {
            document.getElementById('filterSize').classList.add('hidden');
            currentFilters.size_id = '';
        }

        // Renderizar colores
        const colorChips = document.getElementById('colorChips');
        if (filters.has_colors && filters.colors.length > 0) {
            document.getElementById('filterColor').classList.remove('hidden');
            colorChips.innerHTML = `
                <span class="filter-chip active" data-filter="color_id" data-value="">Todos</span>
                ${filters.colors.map(color =>
                    `<span class="filter-chip" data-filter="color_id" data-value="${color.id}">
                        <span class="color-dot me-1" style="background: ${color.hex_code}"></span>
                        ${escapeHtml(color.name)}
                    </span>`
                ).join('')}
            `;
        } else {
            document.getElementById('filterColor').classList.add('hidden');
            currentFilters.color_id = '';
        }

        // Re-asignar event listeners a los nuevos chips
        attachChipListeners();
    }

    function attachChipListeners() {
        document.querySelectorAll('.filter-chip').forEach(chip => {
            chip.removeEventListener('click', handleChipClick);
            chip.addEventListener('click', handleChipClick);
        });
    }

    function handleChipClick(e) {
            const chip = e.currentTarget;
            const filterType = chip.dataset.filter;
            const value = chip.dataset.value;

            // Visual: Toggle active class
            chip.closest('.filter-row').querySelectorAll('.filter-chip').forEach(c => {
                c.classList.remove('active');
            });
            chip.classList.add('active');

            // Actualizar el estado global
            currentFilters[filterType] = value;

            // LÓGICA IMPORTANTE: Si cambia el Tipo de Producto, resetear todo lo demás
            if (filterType === 'product_type') {
                console.log("Cambio de tipo de producto detectado. Reseteando filtros hijos.");
                
                // 1. Limpiar variables de estado
                currentFilters.category_id = '';
                currentFilters.material_id = '';
                currentFilters.size_id = '';
                currentFilters.color_id = '';
                
                // 2. Recargar los filtros disponibles (Materiales, Colores, etc.)
                // Esto llamará a la API y redibujará los chips
                loadAvailableFilters();
            }

            // Aplicar la búsqueda con los nuevos filtros
            applyFilters();
        }

    // === MODO DE SELECCION ===
    function setMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.mode === mode);
        });

        document.getElementById('autoSelectPanel').classList.toggle('show', mode === 'auto');
        document.getElementById('priceFilter').style.display = mode === 'price' ? 'block' : 'none';

        applyFilters();
    }

    // === BUSQUEDA ===
    // Variable para el timer de debounce
    // Variable para el timer de debounce
    let debounceTimer;
    let currentPage = 1; // Track current page

    function handleSearchKeyup(event) {
        clearTimeout(debounceTimer);
        const btn = document.getElementById('clearSearchBtn');
        btn.style.display = event.target.value.length > 0 ? 'block' : 'none';
        
        if (event.key === 'Enter') {
            applyFilters(1); // Reset to page 1 on search
        } else {
            debounceTimer = setTimeout(() => applyFilters(1), 500);
        }
    }

    function clearSearch() {
        document.getElementById('searchInput').value = '';
        document.getElementById('clearSearchBtn').style.display = 'none';
        applyFilters(1);
    }

    function getActiveFilterValue(type) {
        // Map simplified names to actual data-filter names
        let filterName = type;
        if (type === 'category') filterName = 'category_id';
        if (type === 'material') filterName = 'material_id';
        if (type === 'size') filterName = 'size_id';
        if (type === 'color') filterName = 'color_id';
        
        const activeChip = document.querySelector(`.filter-chip.active[data-filter="${filterName}"]`);
        return activeChip ? activeChip.dataset.value : '';
    }

    async function applyFilters(page = 1) {
        showLoading(true);
        currentPage = page; // Update global page

        // Recopilar filtros activos
        const filters = {
            product_type: getActiveFilterValue('product_type'),
            category_id: getActiveFilterValue('category'),
            material_id: getActiveFilterValue('material'),
            size_id: getActiveFilterValue('size'),
            color_id: getActiveFilterValue('color'),
            search: document.getElementById('searchInput').value,
            min_price: document.getElementById('minPrice').value,
            max_price: document.getElementById('maxPrice').value,
            page: currentPage // Send page param
        };

        // Guardar para uso de auto-select
        currentFilters = filters;

        try {
            const response = await fetch('/api/internal-orders/filter-variants/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': CSRF_TOKEN
                },
                body: JSON.stringify(filters)
            });

            const data = await response.json();
            if (data.status === 'ok') {
                renderVariants(data.items);
                document.getElementById('variantCount').textContent = data.count;
                updatePaginationControls(data); // Handle pagination UI
            }
        } catch (error) {
            console.error('Error:', error);
        }

        showLoading(false);
    }

    function changePage(delta) {
        applyFilters(currentPage + delta);
    }

    function updatePaginationControls(data) {
        const controls = document.getElementById('paginationControls');
        const prevBtn = document.getElementById('prevPageBtn');
        const nextBtn = document.getElementById('nextPageBtn');
        const info = document.getElementById('pageInfo');

        if (data.num_pages > 1) {
            controls.style.display = 'flex'; // Use flex to align properly, override none
            controls.style.setProperty('display', 'flex', 'important');
            
            info.textContent = `Página ${data.current_page} de ${data.num_pages}`;
            prevBtn.disabled = !data.has_previous;
            nextBtn.disabled = !data.has_next;
        } else {
            controls.style.setProperty('display', 'none', 'important');
        }
    }

    function renderVariants(items) {
        const grid = document.getElementById('variantsGrid');
        const searchTerm = currentFilters.search;

        if (items.length === 0) {
            let emptyMsg = 'No se encontraron referencias<br>con estos filtros';
            if (searchTerm) {
                emptyMsg = `No se encontraron referencias para<br><strong>"${escapeHtml(searchTerm)}"</strong>`;
            }
            grid.innerHTML = `
                <div class="empty-variants">
                    <i class="bi bi-search"></i>
                    <p>${emptyMsg}</p>
                </div>
            `;
            return;
        }

        grid.innerHTML = items.map(item => {
            let displayName = escapeHtml(item.product_name);
            if (searchTerm) {
                displayName = highlightText(item.product_name, searchTerm);
            }

            return `
            <div class="variant-card"
                 draggable="true"
                 data-variant-id="${item.id}"
                 ondragstart="handleDragStart(event)"
                 ondragend="handleDragEnd(event)"
                 ondblclick="addItemDirect(${item.id})">
                <button class="add-btn" onclick="event.stopPropagation(); addItemDirect(${item.id})">
                    <i class="bi bi-plus"></i>
                </button>
                <img src="${item.product_image || 'https://via.placeholder.com/100x80?text=IMG'}" alt="" onerror="this.src='https://via.placeholder.com/100x80?text=IMG'">
                <div class="name" title="${escapeHtml(item.product_name)}">${displayName}</div>
                
                <div class="d-flex gap-1 flex-wrap mt-2 mb-1">
                    ${item.size ? `<span class="badge bg-light text-dark border">${item.size}</span>` : ''}
                    ${item.color ? `<span class="badge border text-dark d-flex align-items-center gap-1" style="background-color: white;">
                        <span style="width: 8px; height: 8px; border-radius: 50%; background-color: ${item.color_hex}; border: 1px solid rgba(0,0,0,0.1);"></span>
                        ${item.color}
                    </span>` : ''}
                </div>
                
                <div class="details">
                     <span>${item.material || ''}</span>
                </div>
                <div class="price">$${item.price.toLocaleString('es-CO')}</div>
            </div>
        `}).join('');

        // Re-inicializar drag & drop para los nuevos elementos
        initDragAndDrop();
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function highlightText(text, search) {
        if (!search) return escapeHtml(text);
        const regex = new RegExp(`(${escapeRegex(search)})`, 'gi');
        return escapeHtml(text).replace(regex, '<mark class="search-highlight">$1</mark>');
    }

    function escapeRegex(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // === DRAG & DROP MEJORADO ===
    function initDragAndDrop() {
        const variantCards = document.querySelectorAll('.variant-card');
        variantCards.forEach(card => {
            card.setAttribute('draggable', 'true');
        });
    }

    function handleDragStart(e) {
        draggedElement = e.target.closest('.variant-card');
        if (draggedElement) {
            draggedElement.classList.add('dragging');
            e.dataTransfer.setData('text/plain', draggedElement.dataset.variantId);
            e.dataTransfer.effectAllowed = 'copy';
        }
    }

    function handleDragEnd(e) {
        if (draggedElement) {
            draggedElement.classList.remove('dragging');
            draggedElement = null;
        }
        document.getElementById('cartDropZone').classList.remove('drag-over');
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'copy';
        document.getElementById('cartDropZone').classList.add('drag-over');
    }

    function handleDragLeave(e) {
        if (!e.currentTarget.contains(e.relatedTarget)) {
            document.getElementById('cartDropZone').classList.remove('drag-over');
        }
    }

    async function handleDrop(e) {
        e.preventDefault();
        document.getElementById('cartDropZone').classList.remove('drag-over');

        const variantId = e.dataTransfer.getData('text/plain');
        if (variantId) {
            await addItem(variantId);
        }
    }

    // === AGREGAR/ELIMINAR ITEMS ===
    async function addItem(variantId) {
        try {
            const response = await fetch('/api/internal-orders/add-item/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': CSRF_TOKEN
                },
                body: JSON.stringify({
                    order_id: ORDER_ID,
                    variant_id: variantId,
                    quantity: 1
                })
            });

            const data = await response.json();
            if (data.status === 'ok') {
                updateTotals(data.order_totals.total_items, data.order_totals.total_estimated);

                if (data.is_new) {
                    addItemToUI(data.item);
                } else {
                    const itemEl = document.querySelector(`[data-item-id="${data.item.id}"]`);
                    if (itemEl) {
                        itemEl.querySelector('input').value = data.item.quantity;
                    }
                }
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    function addItemDirect(variantId) {
        addItem(variantId);
    }

    function addItemToUI(item) {
        const dropZone = document.getElementById('cartDropZone');
        const hint = document.getElementById('dropHint');

        if (hint) {
            hint.remove();
        }
        dropZone.classList.remove('empty');

        let container = document.getElementById('cartItemsContainer');
        if (!container) {
            container = document.createElement('div');
            container.id = 'cartItemsContainer';
            dropZone.appendChild(container);
        }

        const itemHTML = `
            <div class="cart-item" data-item-id="${item.id}">
                <img src="${item.image_url || 'https://via.placeholder.com/40x40?text=IMG'}" alt="" onerror="this.src='https://via.placeholder.com/40x40?text=IMG'">
                <div class="cart-item-info">
                    <div class="cart-item-name">${escapeHtml(item.product_name)}</div>
                    <div class="cart-item-details">${escapeHtml(item.variant_details)}</div>
                    <div class="cart-item-price">$${item.unit_price.toLocaleString('es-CO')}</div>
                </div>
                <div class="cart-item-qty">
                    <input type="number" value="${item.quantity}" min="1" onchange="updateQuantity(${item.id}, this.value)">
                </div>
                <span class="cart-item-remove" onclick="removeItem(${item.id})">
                    <i class="bi bi-trash"></i>
                </span>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', itemHTML);
    }

    async function removeItem(itemId) {
        if (!confirm('Eliminar este item?')) return;

        try {
            const response = await fetch('/api/internal-orders/remove-item/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': CSRF_TOKEN
                },
                body: JSON.stringify({ item_id: itemId })
            });

            const data = await response.json();
            if (data.status === 'ok') {
                const itemEl = document.querySelector(`[data-item-id="${itemId}"]`);
                if (itemEl) {
                    itemEl.remove();
                }
                updateTotals(data.order_totals.total_items, data.order_totals.total_estimated);

                const container = document.getElementById('cartItemsContainer');
                if (!container || !container.children.length) {
                    showEmptyHint();
                }
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    function showEmptyHint() {
        const dropZone = document.getElementById('cartDropZone');
        const container = document.getElementById('cartItemsContainer');
        if (container) container.remove();

        dropZone.classList.add('empty');
        dropZone.innerHTML = `
            <div class="drop-hint" id="dropHint">
                <i class="bi bi-box-arrow-in-down"></i>
                <p>Arrastra referencias aqui<br>o usa seleccion automatica</p>
            </div>
        `;
    }

    // === SELECCION AUTOMATICA CON REPETICION ===
    async function autoSelect() {
        const quantity = parseInt(document.getElementById('autoQuantity').value);
        showLoading(true);

        try {
            const response = await fetch('/api/internal-orders/auto-select/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': CSRF_TOKEN
                },
                body: JSON.stringify({
                    order_id: ORDER_ID,
                    quantity: quantity,
                    allow_repeat: true, // Permitir repeticion si no hay suficientes
                    ...currentFilters
                })
            });

            const data = await response.json();
            if (data.status === 'ok') {
                data.added_items.forEach(item => {
                    addItemToUI(item);
                });
                updateTotals(data.order_totals.total_items, data.order_totals.total_estimated);
                alert(`Se agregaron ${data.added_count} referencias al pedido`);
            }
        } catch (error) {
            console.error('Error:', error);
        }

        showLoading(false);
    }

    // === ACTUALIZAR CANTIDAD ===
    async function updateQuantity(itemId, newQty) {
        try {
            const response = await fetch('/api/internal-orders/update-quantity/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': CSRF_TOKEN
                },
                body: JSON.stringify({
                    item_id: itemId,
                    quantity: parseInt(newQty)
                })
            });

            const data = await response.json();
            if (data.status === 'ok') {
                updateTotals(data.order_totals.total_items, data.order_totals.total_estimated);
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // === ACTUALIZAR NOMBRE DEL PEDIDO ===
    async function updateOrderName(name) {
        try {
            await fetch('/api/internal-orders/update-info/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': CSRF_TOKEN
                },
                body: JSON.stringify({
                    order_id: ORDER_ID,
                    name: name
                })
            });
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // === VACIAR PEDIDO ===
    async function clearOrder() {
        if (!confirm('Estas seguro de vaciar todo el pedido?')) return;

        try {
            const response = await fetch('/api/internal-orders/clear/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': CSRF_TOKEN
                },
                body: JSON.stringify({ order_id: ORDER_ID })
            });

            const data = await response.json();
            if (data.status === 'ok') {
                showEmptyHint();
                updateTotals(0, 0);
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // === HELPERS ===
    function updateTotals(items, estimated) {
        document.getElementById('totalItems').textContent = items;
        document.getElementById('totalEstimated').textContent = '$' + Math.round(estimated).toLocaleString('es-CO');
    }

    function showLoading(show) {
        document.getElementById('loadingOverlay').classList.toggle('show', show);
    }

    // === EXPORTAR CSV ===
    const cleanCSVData = (data) => {
        if (!data) return "";
        const text = String(data);
        if (text.includes(",") || text.includes('"') || text.includes("\n")) {
            return `"${text.replace(/"/g, '""')}"`;
        }
        return text;
    };

    function downloadOrderCSV() {
        const items = [];
        // Iterar sobre los elementos del DOM o usar datos del backend si están disponibles en JS.
        // Aquí extraemos del DOM para simplicidad, ya que están renderizados.
        const cartItems = document.querySelectorAll('#cartItemsContainer .cart-item');
        
        cartItems.forEach(itemEl => {
            const name = itemEl.querySelector('.cart-item-name').textContent.trim();
            const details = itemEl.querySelector('.cart-item-details').textContent.trim(); // "Grande - Dorado"
            const qty = itemEl.querySelector('input').value;

            // Intentar parsear detalles
            let size = "";
            let color = "";
            
            // Lógica simple de parseo basada en el formato "Size - Material - Color"
            const parts = details.split('-').map(p => p.trim());
            if (parts.length > 0) size = parts[0];
            if (parts.length > 2) color = parts[2]; // Asumiendo Size - Material - Color
            else if (parts.length === 2) color = parts[1]; // Posiblemente Size - Color o Size - Material

            items.push({
                referencia: name,
                cantidad: qty,
                tamano: size, // O todo el string details si se prefiere
                color: color,
                full_details: details
            });
        });

        if (items.length === 0) {
            alert("El pedido está vacío.");
            return;
        }

        const headers = ["Referencia", "Cantidad", "Detalles", "Tamaño (Est)", "Color (Est)"];
        const rows = items.map(item => {
            return [
                cleanCSVData(item.referencia),
                cleanCSVData(item.cantidad),
                cleanCSVData(item.full_details),
                cleanCSVData(item.tamano),
                cleanCSVData(item.color)
            ].join(",");
        });

        const csvContent = [
            headers.join(","),
            ...rows
        ].join("\n");

        const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        const date = new Date().toISOString().slice(0,10);
        link.download = `Pedido_${ORDER_ID}_${date}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }

    // Inicializar al cargar
    document.addEventListener('DOMContentLoaded', async function() {
        // Asignar listeners a los chips de tipo de producto (estaticos)
        attachChipListeners();

        // Cargar filtros dinamicos basados en los datos reales
        await loadAvailableFilters();

        // CHECK URL PARAMS FOR AUTO-SELECTION
        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get('mode');

        if (mode && mode !== 'mixed') {
            const typeChip = document.querySelector(`.filter-chip[data-filter="product_type"][data-value="${mode}"]`);
            if (typeChip) {
                // Simular click en el chip
                typeChip.click();
            } else {
                // Fallback si no encuentra el chip
                 applyFilters();
            }
        } else {
            // Cargar variantes default
            applyFilters();
        }

        // Inicializar drag & drop
        initDragAndDrop();
    });
</script>
{% endblock %}
