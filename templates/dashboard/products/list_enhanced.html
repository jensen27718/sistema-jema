{% extends 'base_admin.html' %}

{% block title %}Productos - JEMA Admin{% endblock %}
{% block page_title %}Gestión de Productos{% endblock %}

{% block content %}
<!-- Barra de acciones superior -->
<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
    <div class="btn-group">
        <button type="button" class="btn btn-outline-secondary" id="massEditBtn" disabled>
            <i class="bi bi-pencil-square me-2"></i> Edición Masiva
        </button>
        <button type="button" class="btn btn-outline-secondary dropdown-toggle dropdown-toggle-split"
                data-bs-toggle="dropdown" id="quickActionsBtn" disabled>
            <span class="visually-hidden">Acciones rápidas</span>
        </button>
        <ul class="dropdown-menu">
            <li>
                <a class="dropdown-item" href="#" data-action="set_online">
                    <i class="bi bi-eye text-success me-2"></i> Poner En Línea
                </a>
            </li>
            <li>
                <a class="dropdown-item" href="#" data-action="set_offline">
                    <i class="bi bi-eye-slash text-warning me-2"></i> Poner Fuera de Línea
                </a>
            </li>
            <li><hr class="dropdown-divider"></li>
            <li>
                <a class="dropdown-item" href="#" data-action="set_active">
                    <i class="bi bi-check-circle text-success me-2"></i> Marcar como Activo
                </a>
            </li>
            <li>
                <a class="dropdown-item" href="#" data-action="set_inactive">
                    <i class="bi bi-x-circle text-danger me-2"></i> Marcar como Inactivo
                </a>
            </li>
            <li><hr class="dropdown-divider"></li>
            <li>
                <a class="dropdown-item" href="#" data-action="add_categories">
                    <i class="bi bi-tag text-primary me-2"></i> Agregar Categorías
                </a>
            </li>
            <li>
                <a class="dropdown-item" href="#" data-action="remove_categories">
                    <i class="bi bi-tag-fill text-secondary me-2"></i> Quitar Categorías
                </a>
            </li>
            <li>
                <a class="dropdown-item" href="#" data-action="change_type">
                    <i class="bi bi-box me-2 text-info"></i> Cambiar Tipo
                </a>
            </li>
            <li>
                <a class="dropdown-item" href="#" data-action="change_description">
                    <i class="bi bi-text-left me-2 text-dark"></i> Cambiar Descripción
                </a>
            </li>
            <li><hr class="dropdown-divider"></li>
            <li>
                <a class="dropdown-item" href="#" data-action="delete_products"
                   onclick="return confirm('¿Eliminar los productos seleccionados? Esta acción no se puede deshacer.')">
                    <i class="bi bi-trash text-danger me-2"></i> Eliminar Productos
                </a>
            </li>
        </ul>
    </div>

    <div class="d-flex gap-2">
        <a href="{% url 'bulk_upload' %}" class="btn btn-jema-teal">
            <i class="bi bi-cloud-upload me-2"></i> Carga Masiva
        </a>
        <a href="{% url 'panel_product_create' %}" class="btn btn-jema-primary">
            <i class="bi bi-plus-circle me-2"></i> Nuevo Producto
        </a>
    </div>
</div>

<!-- Filtros -->
<div class="jema-card p-3 mb-4">
    <form id="filterForm" class="row g-3 align-items-end">
        <div class="col-md-3">
            <label class="form-label small mb-1">Buscar</label>
            <input type="text" name="q" class="form-control"
                   placeholder="Nombre o descripción..." value="{{ search_query }}">
        </div>
        <div class="col-md-2">
            <label class="form-label small mb-1">Categoría</label>
            <select name="category" class="form-select">
                <option value="">Todas</option>
                {% for cat in categories %}
                <option value="{{ cat.id }}" {% if cat.id|stringformat:"s" == current_category %}selected{% endif %}>
                    {{ cat.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label small mb-1">Tipo</label>
            <select name="type" class="form-select">
                <option value="">Todos</option>
                {% for value, label in product_types %}
                <option value="{{ value }}" {% if value == current_type %}selected{% endif %}>
                    {{ label }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label small mb-1">Estado</label>
            <select name="online" class="form-select">
                <option value="">Todos</option>
                <option value="1" {% if current_online == "1" %}selected{% endif %}>En Línea</option>
                <option value="0" {% if current_online == "0" %}selected{% endif %}>Fuera de Línea</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label small mb-1">Ordenar por</label>
            <select name="sort" class="form-select">
                <option value="-created_at" {% if current_sort == "-created_at" %}selected{% endif %}>Más recientes</option>
                <option value="created_at" {% if current_sort == "created_at" %}selected{% endif %}>Más antiguos</option>
                <option value="name" {% if current_sort == "name" %}selected{% endif %}>Nombre (A-Z)</option>
                <option value="-name" {% if current_sort == "-name" %}selected{% endif %}>Nombre (Z-A)</option>
            </select>
        </div>
        <div class="col-md-1">
             <!-- Spinner de carga -->
             <div id="loadingSpinner" class="spinner-border text-primary spinner-border-sm d-none" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </form>
</div>

<!-- Tabla de productos -->
<div class="jema-card">
    <form id="massEditForm" method="post" action="{% url 'mass_edit_products' %}">
        {% csrf_token %}
        <div id="product-results-container">
            {% include 'dashboard/products/partials/product_list_results.html' %}
        </div>
    </form>
</div>

<!-- Modal para editar categorías -->
<div class="modal fade" id="categoryEditModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fs-6">Editar Categorías</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="modalProductId">
                <div class="d-flex flex-column gap-2" style="max-height: 300px; overflow-y: auto;">
                    {% for cat in categories %}
                    <div class="form-check">
                        <input class="form-check-input category-checkbox-modal" type="checkbox" value="{{ cat.id }}" id="catModal{{ cat.id }}">
                        <label class="form-check-label" for="catModal{{ cat.id }}">
                            {{ cat.name }}
                        </label>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="modal-footer p-1">
                <button type="button" class="btn btn-sm btn-primary w-100" id="saveCategoryBtn">Guardar</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const filterForm = document.getElementById('filterForm');
    const container = document.getElementById('product-results-container');
    const spinner = document.getElementById('loadingSpinner');
    let debounceTimer;

    // --- FUNCIONES AJAX ---

    function fetchProducts(url = null) {
        spinner.classList.remove('d-none');
        
        // Construir URL con parámetros
        const formData = new FormData(filterForm);
        const params = new URLSearchParams(formData);
        
        let fetchUrl = url || `${window.location.pathname}?${params.toString()}`;

        fetch(fetchUrl, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            container.innerHTML = html;
            initEventListeners(); // Re-inicializar eventos después de actualizar DOM
            spinner.classList.add('d-none');
            
            // Actualizar URL del navegador sin recargar (opcional, para compartir links)
            window.history.pushState({}, '', fetchUrl);
        })
        .catch(err => {
            console.error('Error fetching products:', err);
            spinner.classList.add('d-none');
        });
    }

    // --- EVENT LISTENERS FILTROS ---

    filterForm.addEventListener('change', () => fetchProducts());
    
    // Búsqueda con debounce para no saturar
    filterForm.querySelector('input[name="q"]').addEventListener('input', function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => fetchProducts(), 500);
    });


    // --- EVENT LISTENERS DINÁMICOS (se llaman al inicio y tras AJAX) ---

    function initEventListeners() {
        // 1. Checkboxes masivos
        const selectAll = document.getElementById('selectAll');
        if(selectAll) {
            selectAll.addEventListener('change', function() {
                document.querySelectorAll('.product-checkbox').forEach(cb => {
                    cb.checked = this.checked;
                });
                updateMassEditButtons();
            });
        }

        document.querySelectorAll('.product-checkbox').forEach(cb => {
            cb.addEventListener('change', updateMassEditButtons);
        });
        updateMassEditButtons(); // Resetear estado botones

        // 2. Paginación AJAX
        document.querySelectorAll('.ajax-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                fetchProducts(this.href);
            });
        });

        // 3. Edición Inline: NOMBRE
        document.querySelectorAll('.editable-name').forEach(el => {
            el.addEventListener('dblclick', function() {
               // ... (Mismo código anterior) ...
               // Por brevedad, lo dejo similar pero mejorado
               const productId = this.dataset.productId;
               const currentName = this.textContent.trim();
               const newName = prompt('Nombre:', currentName);
               if (newName && newName !== currentName) updateField(productId, 'name', newName, this);
            });
        });

        // 4. Edición Inline: DESCRIPCIÓN (Textarea)
        document.querySelectorAll('.editable-description').forEach(el => {
            el.addEventListener('dblclick', function() {
                if (this.querySelector('textarea')) return; // Ya editando

                const currentText = this.innerText.trim() === 'Sin descripción' ? '' : this.innerText.trim();
                const productId = this.dataset.productId;
                
                // Reemplazar con textarea
                this.innerHTML = `
                    <textarea class="form-control form-control-sm" rows="3" style="min-width: 200px;">${currentText}</textarea>
                    <div class="mt-1 d-flex gap-1 justify-content-end">
                        <button class="btn btn-xs btn-outline-danger cancel-desc"><i class="bi bi-x"></i></button>
                        <button class="btn btn-xs btn-outline-success save-desc"><i class="bi bi-check"></i></button>
                    </div>
                `;
                
                const textarea = this.querySelector('textarea');
                textarea.focus();

                // Manejador tecla Enter (Guardar)
                textarea.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.querySelector('.save-desc').click();
                    }
                });

                // Manejadores botones
                this.querySelector('.save-desc').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const newVal = textarea.value;
                    updateField(productId, 'description', newVal, this, true); // true = render html
                });
                
                this.querySelector('.cancel-desc').addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.innerHTML = currentText || '<em class="text-muted">Sin descripción</em>';
                });
            });
        });

        // 5. Edición Inline: CATEGORÍAS (Modal)
        document.querySelectorAll('.editable-categories').forEach(el => {
            el.addEventListener('click', function() {
                const productId = this.dataset.productId;
                const currentCats = this.dataset.currentCategories.split(',').filter(Boolean);
                
                // Popular modal
                document.getElementById('modalProductId').value = productId;
                document.querySelectorAll('.category-checkbox-modal').forEach(cb => {
                    cb.checked = currentCats.includes(cb.value);
                });
                
                // Mostrar modal
                const modal = new bootstrap.Modal(document.getElementById('categoryEditModal'));
                modal.show();

                // Guardar referencia al elemento para actualizar UI después
                window.currentCategoryElement = this;
            });
        });

        // 6. Toggle Online
        document.querySelectorAll('.online-toggle').forEach(toggle => {
            toggle.addEventListener('change', function() {
                updateField(this.dataset.productId, 'is_online', this.checked, this.nextElementSibling.querySelector('span'), false, true);
            });
        });

        // 7. Toggle Active
        document.querySelectorAll('.active-toggle').forEach(toggle => {
            toggle.addEventListener('change', function() {
                updateField(this.dataset.productId, 'is_active', this.checked, this.nextElementSibling.querySelector('span'), false, false, true);
            });
        });
    }

    // --- UTILS ---

    function updateMassEditButtons() {
        const selected = document.querySelectorAll('.product-checkbox:checked').length;
        const btn1 = document.getElementById('massEditBtn');
        const btn2 = document.getElementById('quickActionsBtn');
        if(btn1) btn1.disabled = selected === 0;
        if(btn2) btn2.disabled = selected === 0;
    }

    function updateField(productId, field, value, uiElement, isHtml = false, isOnlineToggle = false, isActiveToggle = false) {
        const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        fetch('{% url "inline_edit_product" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrf
            },
            body: JSON.stringify({
                product_id: productId,
                field: field,
                value: value
            })
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === 'ok') {
                // UI Updates
                if (isOnlineToggle) {
                    if (value) {
                        uiElement.innerHTML = '<i class="bi bi-eye me-1"></i>En línea';
                        uiElement.className = 'text-success';
                    } else {
                        uiElement.innerHTML = '<i class="bi bi-eye-slash me-1"></i>Offline';
                        uiElement.className = 'text-muted';
                    }
                } else if (isActiveToggle) {
                    if (value) {
                        uiElement.innerHTML = '<i class="bi bi-check-circle me-1"></i>Activo';
                        uiElement.className = 'text-success';
                    } else {
                        uiElement.innerHTML = '<i class="bi bi-x-circle me-1"></i>Inactivo';
                        uiElement.className = 'text-danger';
                    }
                } else if (field === 'description') {
                     uiElement.innerHTML = value || '<em class="text-muted">Sin descripción</em>';
                } else if (field === 'name') {
                    uiElement.textContent = value;
                    uiElement.classList.add('text-success');
                    setTimeout(() => uiElement.classList.remove('text-success'), 1000);
                }
            } else {
                alert('Error: ' + data.message);
            }
        });
    }

    // --- MODAL SAVE CATEGORIES ---
    document.getElementById('saveCategoryBtn').addEventListener('click', function() {
        const productId = document.getElementById('modalProductId').value;
        const selected = Array.from(document.querySelectorAll('.category-checkbox-modal:checked')).map(cb => cb.value);
        
        const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        fetch('{% url "inline_edit_product" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrf },
            body: JSON.stringify({ product_id: productId, field: 'categories', value: selected })
        })
        .then(res => res.json())
        .then(data => {
             if(data.status === 'ok') {
                 // Update UI
                 const el = window.currentCategoryElement;
                 if(el) {
                     // data.new_value debe ser [{id, name}, ...]
                     const cats = data.new_value;
                     let html = '';
                     let ids = '';
                     cats.forEach(c => {
                         html += `<span class="jema-badge jema-badge-teal me-1 mb-1">${c.name}</span>`;
                         ids += c.id + ',';
                     });
                     if(cats.length === 0) html = '<span class="text-muted small">Sin categoría</span>';
                     
                     el.innerHTML = html;
                     el.dataset.currentCategories = ids;
                 }
                 
                 // Cerrar modal
                 const modalEl = document.getElementById('categoryEditModal');
                 const modal = bootstrap.Modal.getInstance(modalEl);
                 modal.hide();
             }
        });
    });
    
    // --- MASS ACTIONS (AJAX) ---
    document.querySelectorAll('[data-action]').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const action = this.dataset.action;
            const form = document.getElementById('massEditForm');
            const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            // Recoger IDs
            const ids = Array.from(document.querySelectorAll('.product-checkbox:checked')).map(cb => cb.value);
            if(ids.length === 0) return;

            // Para acciones simples, usar AJAX completo.
            // Para acciones complejas (cambiar tipo, etc) que requieren form extra, 
            // quizás sea mejor dejar el submit normal O implementar modal.
            // Por ahora, implementamos las simples inline.
            
            // Crear FormData compatible con la vista existente
            const formData = new FormData();
            formData.append('action', action);
            ids.forEach(id => formData.append('selected_products', id));
            
            fetch(form.action, {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrf },
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'ok') {
                    // Refrescar tabla MANTENIENDO la URL actual (filtros y página)
                    // No pasamos URL, así fetchProducts usa window.location.search
                    fetchProducts(); 
                    // Toast o alerta opcional
                } else {
                    // Si falla o la vista redirige (que no debería con AJAX),
                    // tal vez sea una acción compleja que requiere la vista completa.
                    // Si es "add_categories", etc. la vista actual espera redirigir a un form intermedio.
                    // Para soportar eso 100% AJAX necesitaríamos modales para todo.
                    // Por simplicidad en este paso, si la acción requiere input extra y la vista falló,
                    // hacemos submit normal.
                     if (['add_categories', 'remove_categories', 'change_type', 'change_description'].includes(action)) {
                         const input = document.createElement('input');
                         input.type = 'hidden';
                         input.name = 'action';
                         input.value = action;
                         form.appendChild(input);
                         form.submit(); // Fallback a submit normal para forms intermedios
                     } else {
                        alert('Error: ' + (data.message || 'Desconocido'));
                     }
                }
            })
            .catch(err => {
                 // Si falla el fetch (ej. la vista redirigió a HTML), hacemos submit normal
                 const input = document.createElement('input');
                 input.type = 'hidden';
                 input.name = 'action';
                 input.value = action;
                 form.appendChild(input);
                 form.submit();
            });
        });
    });


    // Inicializar al cargar
    initEventListeners();
});
</script>
{% endblock %}
