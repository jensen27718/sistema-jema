{% extends 'base_admin.html' %}
{% load humanize %}

{% block title %}Pedido #{{ order.id }} - JEMA{% endblock %}
{% block page_title %}
<div class="d-flex align-items-center gap-3">
    <a href="{% url 'panel_pedidos' %}" class="btn btn-sm btn-light rounded-circle"
        style="width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center;">
        <i class="bi bi-arrow-left"></i>
    </a>
    Detalle del Pedido #{{ order.id }}
</div>
{% endblock %}

{% block content %}
<div class="row g-4">
    <div class="col-lg-8">
        <div class="jema-card p-4 h-100">
            <h6 class="text-muted fw-bold small mb-3 text-uppercase">Productos del Pedido</h6>

            <div class="d-flex flex-column gap-3">
                {% for item in order.items.all %}
                <div class="d-flex align-items-center gap-3 p-3 rounded-3 bg-light border">
                    <div class="bg-white rounded p-2 border d-flex align-items-center justify-content-center"
                        style="width: 50px; height: 50px;">
                        <i class="bi bi-box text-muted"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-0 fw-bold">{{ item.product_name }}</h6>
                        <span class="small text-muted">{{ item.variant_text }}</span>
                    </div>
                    <div class="text-end">
                        <span class="d-block small text-muted">{{ item.quantity }} x ${{ item.price|intcomma }}</span>
                        <span class="fw-bold">${{ item.get_total|intcomma }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="mt-4 pt-3 border-top d-flex justify-content-between align-items-center">
                <span class="text-muted">Total del Pedido</span>
                <h3 class="jema-text-gradient fw-bold mb-0">${{ order.total|intcomma }}</h3>
            </div>
        </div>

        <div class="jema-card p-4 mt-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="text-muted fw-bold small text-uppercase mb-0">Costos del Pedido</h6>
                <button class="btn btn-sm btn-jema-primary" onclick="openCostModal()">
                    <i class="bi bi-plus-lg"></i> Agregar gasto
                </button>
            </div>

            <div class="table-responsive">
                <table class="table table-sm mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th>Tipo</th>
                            <th>Descripcion</th>
                            <th>Estado Contable</th>
                            <th class="text-end">Total</th>
                            <th class="text-end">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="costsBody">
                        {% for breakdown in cost_breakdowns %}
                        <tr data-breakdown-id="{{ breakdown.id }}">
                            <td>{{ breakdown.cost_type.name }}</td>
                            <td>
                                <div class="fw-medium">{{ breakdown.description }}</div>
                                {% if breakdown.notes %}
                                <small class="text-muted">{{ breakdown.notes }}</small>
                                {% endif %}
                            </td>
                            <td>
                                {% if breakdown.accounting_status == 'posted' %}
                                <span class="badge bg-success">Registrado</span>
                                {% else %}
                                <span class="badge bg-warning text-dark">Pendiente</span>
                                {% endif %}
                                {% if breakdown.accounting_category %}
                                <div><small class="text-muted">{{ breakdown.accounting_category.name }}</small></div>
                                {% endif %}
                            </td>
                            <td class="text-end fw-bold">${{ breakdown.total|floatformat:0 }}</td>
                            <td class="text-end">
                                {% if breakdown.accounting_status == 'posted' %}
                                    {% if breakdown.accounting_transaction_id %}
                                    <a class="btn btn-sm btn-outline-success" href="{% url 'accounting_transaction_update' breakdown.accounting_transaction_id %}">
                                        <i class="bi bi-box-arrow-up-right"></i>
                                    </a>
                                    {% endif %}
                                {% else %}
                                <button class="btn btn-sm btn-outline-secondary" onclick="openCostModal({{ breakdown.id }})">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="openPostModal({{ breakdown.id }})">
                                    <i class="bi bi-cash-coin"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteCost({{ breakdown.id }})">
                                    <i class="bi bi-trash"></i>
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr id="noCostsRow">
                            <td colspan="5" class="text-center text-muted py-2">
                                Sin gastos registrados
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="border-top pt-3 mt-3">
                <div class="row align-items-center mb-2">
                    <div class="col-6"><small class="text-muted">Envio</small></div>
                    <div class="col-6">
                        <div class="input-group input-group-sm" style="max-width: 150px; margin-left: auto;">
                            <span class="input-group-text">$</span>
                            <input type="number" step="1" min="0" class="form-control"
                                id="shippingCostInput" value="{{ order.shipping_cost|floatformat:0 }}"
                                onchange="updateShipping()">
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-between">
                    <span class="fw-bold">Total Costos:</span>
                    <span class="fw-bold text-danger" id="grandTotal">${{ grand_total_cost|floatformat:0|default:"0" }}</span>
                </div>
                <div class="d-flex justify-content-between">
                    <span>Margen:</span>
                    <span class="fw-bold {% if margin >= 0 %}text-success{% else %}text-danger{% endif %}" id="marginDisplay">
                        ${{ margin|floatformat:0|default:"0" }}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="jema-card p-4 mb-4">
            <h6 class="text-muted fw-bold small mb-3 text-uppercase">Estado Actual</h6>

            <div class="text-center py-3 rounded-3 mb-4"
                style="background-color: {{ order.status.color }}15; border: 1px solid {{ order.status.color }}30;">
                <h4 class="mb-0 fw-bold" style="color: {{ order.status.color }};">
                    {{ order.status.name|default:"Sin Estado" }}
                </h4>
            </div>

            <form method="POST">
                {% csrf_token %}
                <label class="form-label small text-muted fw-bold">CAMBIAR ESTADO</label>
                <div class="d-flex gap-2">
                    <select name="status_id" class="form-select">
                        {% for status in statuses %}
                        <option value="{{ status.id }}" {% if order.status_id == status.id %}selected{% endif %}>
                            {{ status.name }}
                        </option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="btn btn-dark">
                        <i class="bi bi-check-lg"></i>
                    </button>
                </div>
            </form>
        </div>

        <div class="jema-card p-4 mb-4" id="financialStatusCard">
            <h6 class="text-muted fw-bold small mb-3 text-uppercase">Estado Financiero</h6>
            {% if financial_status %}
            <div class="text-center py-2 rounded-3 mb-3" id="fsBadgeContainer">
                <span class="badge {{ financial_status.get_state_badge_class }} fs-6" id="fsBadge">
                    {{ financial_status.get_state_display }}
                </span>
            </div>
            <div class="d-flex gap-2 flex-wrap mb-3">
                {% if financial_status.state == 'creado' %}
                <button class="btn btn-sm btn-outline-primary flex-fill" onclick="transitionFinancialState({{ financial_status.id }}, 'enviado')">
                    <i class="bi bi-truck"></i> Enviado
                </button>
                {% endif %}
                {% if financial_status.state == 'enviado' %}
                <button class="btn btn-sm btn-outline-success flex-fill" onclick="transitionFinancialState({{ financial_status.id }}, 'cobrado')">
                    <i class="bi bi-cash-coin"></i> Cobrado
                </button>
                {% endif %}
                {% if financial_status.state != 'cancelado' %}
                <button class="btn btn-sm btn-outline-danger" onclick="transitionFinancialState({{ financial_status.id }}, 'cancelado')">
                    <i class="bi bi-x-lg"></i>
                </button>
                {% endif %}
            </div>
            <div class="border-top pt-3" id="profitPreview">
                <small class="text-muted fw-bold d-block mb-2">RENTABILIDAD ESTIMADA</small>
                <div id="profitData" class="text-center text-muted small">
                    <button class="btn btn-sm btn-outline-secondary" onclick="loadProfitability({{ financial_status.id }})">
                        <i class="bi bi-calculator"></i> Calcular
                    </button>
                </div>
            </div>
            {% else %}
            <p class="text-muted small mb-0">Sin estado financiero asignado.</p>
            {% endif %}
        </div>

        <div class="jema-card p-4">
            <h6 class="text-muted fw-bold small mb-3 text-uppercase">Datos de Envio</h6>

            <div class="mb-3">
                <label class="d-block small text-muted">Cliente</label>
                <span class="fw-medium">{{ order.address.full_name }}</span>
            </div>

            <div class="mb-3">
                <label class="d-block small text-muted">Telefono</label>
                <a href="https://wa.me/57{{ order.address.phone }}" target="_blank" class="text-decoration-none">
                    <i class="bi bi-whatsapp text-success me-1"></i> {{ order.address.phone }}
                </a>
            </div>

            <div class="mb-3">
                <label class="d-block small text-muted">Direccion</label>
                <div>{{ order.address.address_line }}</div>
                <div class="small text-muted">{{ order.address.neighborhood }}</div>
                <div class="fw-medium">{{ order.address.city }} - {{ order.address.department }}</div>
            </div>

            <hr>

            <div class="d-grid">
                <a href="https://wa.me/57{{ order.address.phone }}?text=Hola%20{{ order.address.full_name }},%20te%20escribimos%20de%20JEMA%20sobre%20tu%20pedido%20%23{{ order.id }}..."
                    target="_blank" class="btn btn-outline-success">
                    <i class="bi bi-whatsapp me-2"></i> Contactar Cliente
                </a>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="costModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="costModalTitle">Agregar gasto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="costBreakdownId">
                <div class="mb-3">
                    <label class="form-label">Tipo de gasto</label>
                    <select id="costTypeInput" class="form-select">
                        {% for ct in cost_types %}
                        <option value="{{ ct.id }}" data-default-category="{{ ct.accounting_category_id|default:'' }}">{{ ct.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Descripcion</label>
                    <input type="text" class="form-control" id="costDescriptionInput" placeholder="Ej: Descartonado frente">
                </div>
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <label class="form-label">Cantidad <span id="costUnitLabel" class="text-muted small"></span></label>
                        <input type="number" step="any" min="0" class="form-control" id="costQuantityInput">
                    </div>
                    <div class="col-6">
                        <label class="form-label">Precio Unitario</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" step="any" min="0" class="form-control" id="costUnitPriceInput">
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Total Gasto</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" step="any" min="0" class="form-control fw-bold" id="costTotalInput" readonly>
                    </div>
                    <small class="text-muted">Se calcula automáticamente: Cantidad × Precio</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">Categoria contable sugerida</label>
                    <select id="costAccountingCategoryInput" class="form-select">
                        <option value="">Sin categoria</option>
                        {% for category in accounting_categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-0">
                    <label class="form-label">Notas</label>
                    <textarea id="costNotesInput" class="form-control" rows="2" placeholder="Opcional"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button class="btn btn-jema-primary" onclick="saveCost()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="postCostModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Registrar pago en contabilidad</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="postBreakdownId">
                <div class="alert alert-light border mb-3" id="postBreakdownLabel"></div>
                <div class="mb-3">
                    <label class="form-label">Cuenta</label>
                    <select id="postAccountInput" class="form-select">
                        {% for account in accounting_accounts %}
                        <option value="{{ account.id }}">{{ account.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Categoria contable</label>
                    <select id="postCategoryInput" class="form-select">
                        <option value="">Usar categoria del gasto</option>
                        {% for category in accounting_categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Fecha</label>
                    <input type="date" id="postDateInput" class="form-control">
                </div>
                <div class="mb-0">
                    <label class="form-label">Descripcion movimiento</label>
                    <input type="text" id="postDescriptionInput" class="form-control" placeholder="Opcional">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button class="btn btn-success" onclick="postCostToAccounting()">Registrar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const csrfToken = '{{ csrf_token }}';
const orderId = {{ order.id }};
let costsCache = {};

const costTypeDefaults = {
    {% for ct in cost_types %}
    {{ ct.id }}: {
        name: '{{ ct.name|escapejs }}',
        defaultCategory: '{{ ct.accounting_category_id|default:"" }}',
        unit: '{{ ct.get_unit_display|escapejs }}',
        price: {{ ct.default_unit_price|stringformat:".2f" }}
    },
    {% endfor %}
};

const costModal = new bootstrap.Modal(document.getElementById('costModal'));
const postCostModal = new bootstrap.Modal(document.getElementById('postCostModal'));
const transactionUrlTemplate = '{% url "accounting_transaction_update" 0 %}';

function escapeHtml(value) {
    return String(value || '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
}

function currency(value) {
    const num = parseFloat(value || 0);
    return '$' + Math.round(num).toLocaleString();
}

function toDateInputValue(today = new Date()) {
    const offset = today.getTimezoneOffset();
    const adjusted = new Date(today.getTime() - (offset * 60 * 1000));
    return adjusted.toISOString().split('T')[0];
}

function accountingUrl(id) {
    return transactionUrlTemplate.replace('/0/', '/' + id + '/');
}

function refreshTotals(payload) {
    document.getElementById('grandTotal').textContent = currency(payload.grand_total);
    const margin = parseFloat(payload.margin || 0);
    const marginEl = document.getElementById('marginDisplay');
    marginEl.textContent = currency(margin);
    marginEl.className = 'fw-bold ' + (margin >= 0 ? 'text-success' : 'text-danger');
}

function renderCosts(breakdowns) {
    const tbody = document.getElementById('costsBody');
    costsCache = {};

    if (!breakdowns || breakdowns.length === 0) {
        tbody.innerHTML = `
            <tr id="noCostsRow">
                <td colspan="5" class="text-center text-muted py-2">Sin gastos registrados</td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = '';
    breakdowns.forEach((b) => {
        costsCache[b.id] = b;
        const statusBadge = b.accounting_status === 'posted'
            ? '<span class="badge bg-success">Registrado</span>'
            : '<span class="badge bg-warning text-dark">Pendiente</span>';
        const categoryText = b.accounting_category_name ? `<div><small class="text-muted">${escapeHtml(b.accounting_category_name)}</small></div>` : '';

        let actions = '';
        if (b.accounting_status === 'posted') {
            if (b.accounting_transaction_id) {
                actions = `<a class="btn btn-sm btn-outline-success" href="${accountingUrl(b.accounting_transaction_id)}"><i class="bi bi-box-arrow-up-right"></i></a>`;
            }
        } else {
            actions = `
                <button class="btn btn-sm btn-outline-secondary" onclick="openCostModal(${b.id})"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-sm btn-outline-primary" onclick="openPostModal(${b.id})"><i class="bi bi-cash-coin"></i></button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteCost(${b.id})"><i class="bi bi-trash"></i></button>
            `;
        }

        const notes = b.notes ? `<small class="text-muted">${escapeHtml(b.notes)}</small>` : '';
        tbody.innerHTML += `
            <tr data-breakdown-id="${b.id}">
                <td>${escapeHtml(b.cost_type_name)}</td>
                <td>
                    <div class="fw-medium">${escapeHtml(b.description)}</div>
                    ${notes}
                </td>
                <td>${statusBadge}${categoryText}</td>
                <td class="text-end fw-bold">${currency(b.total)}</td>
                <td class="text-end">${actions}</td>
            </tr>
        `;
    });
}

function fetchCosts() {
    fetch('{% url "api_get_order_costs" %}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
        body: JSON.stringify({order_type: 'catalog', order_id: orderId})
    })
    .then((r) => r.json())
    .then((res) => {
        if (!res.ok) {
            alert(res.error || 'No se pudieron cargar los costos');
            return;
        }
        renderCosts(res.breakdowns || []);
        refreshTotals(res);
    })
    .catch(() => alert('Error de conexion al cargar costos'));
}

function openCostModal(breakdownId = null) {
    document.getElementById('costBreakdownId').value = breakdownId || '';
    const costTypeInput = document.getElementById('costTypeInput');
    const descriptionInput = document.getElementById('costDescriptionInput');
    const totalInput = document.getElementById('costTotalInput');
    const notesInput = document.getElementById('costNotesInput');
    const accountingCategoryInput = document.getElementById('costAccountingCategoryInput');

    if (!breakdownId) {
        document.getElementById('costModalTitle').textContent = 'Agregar gasto';
        if (costTypeInput.options.length > 0) {
            costTypeInput.selectedIndex = 0;
            document.getElementById('costQuantityInput').value = 1;
            onCostTypeChange();
        } else {
            document.getElementById('costDescriptionInput').value = '';
            document.getElementById('costQuantityInput').value = '';
            document.getElementById('costUnitPriceInput').value = '';
            accountingCategoryInput.value = '';
            totalInput.value = '';
        }
        notesInput.value = '';
    } else {
        const breakdown = costsCache[breakdownId];
        if (!breakdown) {
            alert('No se encontro el gasto seleccionado.');
            return;
        }
        document.getElementById('costModalTitle').textContent = 'Editar gasto';
        costTypeInput.value = breakdown.cost_type_id;
        descriptionInput.value = breakdown.description;
        document.getElementById('costQuantityInput').value = parseFloat(breakdown.quantity || 1);
        document.getElementById('costUnitPriceInput').value = parseFloat(breakdown.unit_price || 0);
        totalInput.value = parseFloat(breakdown.total || 0);
        notesInput.value = breakdown.notes || '';
        accountingCategoryInput.value = breakdown.accounting_category_id || '';
        
        const selected = breakdown.cost_type_id;
        document.getElementById('costUnitLabel').textContent = costTypeDefaults[selected] ? `(${costTypeDefaults[selected].unit})` : '';
    }

    costModal.show();
}

function calculateCostTotal() {
    const qty = parseFloat(document.getElementById('costQuantityInput').value || 0);
    const price = parseFloat(document.getElementById('costUnitPriceInput').value || 0);
    document.getElementById('costTotalInput').value = (qty * price).toFixed(2);
}

function onCostTypeChange() {
    const costTypeInput = document.getElementById('costTypeInput');
    const descriptionInput = document.getElementById('costDescriptionInput');
    const accountingCategoryInput = document.getElementById('costAccountingCategoryInput');
    const qtyInput = document.getElementById('costQuantityInput');
    const priceInput = document.getElementById('costUnitPriceInput');
    const unitLabel = document.getElementById('costUnitLabel');
    const selected = costTypeInput.value;
    const isNew = !document.getElementById('costBreakdownId').value;

    if (isNew && !descriptionInput.value.trim()) {
        descriptionInput.value = costTypeDefaults[selected]?.name || '';
    }
    if (!accountingCategoryInput.value) {
        accountingCategoryInput.value = costTypeDefaults[selected]?.defaultCategory || '';
    }
    
    if (costTypeDefaults[selected]) {
        unitLabel.textContent = `(${costTypeDefaults[selected].unit})`;
        if (isNew || !priceInput.value) {
            priceInput.value = costTypeDefaults[selected].price;
        }
    } else {
        unitLabel.textContent = '';
    }
    calculateCostTotal();
}

function saveCost() {
    const breakdownId = document.getElementById('costBreakdownId').value;
    const payload = {
        order_type: 'catalog',
        order_id: orderId,
        cost_type_id: document.getElementById('costTypeInput').value,
        description: document.getElementById('costDescriptionInput').value,
        calculated_quantity: document.getElementById('costQuantityInput').value || 1,
        unit_price: document.getElementById('costUnitPriceInput').value || 0,
        total: document.getElementById('costTotalInput').value || 0,
        notes: document.getElementById('costNotesInput').value,
        accounting_category_id: document.getElementById('costAccountingCategoryInput').value || null
    };

    const url = breakdownId ? '{% url "api_update_order_cost" %}' : '{% url "api_create_order_cost" %}';
    if (breakdownId) {
        payload.breakdown_id = parseInt(breakdownId, 10);
    }

    fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
        body: JSON.stringify(payload)
    })
    .then((r) => r.json())
    .then((res) => {
        if (!res.ok) {
            alert(res.error || 'No se pudo guardar el gasto');
            return;
        }
        costModal.hide();
        fetchCosts();
    })
    .catch(() => alert('Error de conexion al guardar gasto'));
}

function deleteCost(breakdownId) {
    if (!confirm('Eliminar este gasto del pedido?')) return;
    fetch('{% url "api_delete_order_cost" %}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
        body: JSON.stringify({breakdown_id: breakdownId})
    })
    .then((r) => r.json())
    .then((res) => {
        if (!res.ok) {
            alert(res.error || 'No se pudo eliminar el gasto');
            return;
        }
        fetchCosts();
    })
    .catch(() => alert('Error de conexion al eliminar gasto'));
}

function openPostModal(breakdownId) {
    document.getElementById('postBreakdownId').value = breakdownId;
    document.getElementById('postBreakdownLabel').textContent = costsCache[breakdownId]?.description || 'Gasto';
    document.getElementById('postCategoryInput').value = '';
    document.getElementById('postDescriptionInput').value = '';
    document.getElementById('postDateInput').value = toDateInputValue();
    postCostModal.show();
}

function postCostToAccounting() {
    const breakdownId = document.getElementById('postBreakdownId').value;
    const payload = {
        breakdown_id: parseInt(breakdownId, 10),
        account_id: document.getElementById('postAccountInput').value,
        category_id: document.getElementById('postCategoryInput').value || null,
        date: document.getElementById('postDateInput').value,
        description: document.getElementById('postDescriptionInput').value
    };

    fetch('{% url "api_post_order_cost_to_accounting" %}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
        body: JSON.stringify(payload)
    })
    .then((r) => r.json())
    .then((res) => {
        if (!res.ok) {
            alert(res.error || 'No se pudo registrar el gasto en contabilidad');
            return;
        }
        postCostModal.hide();
        fetchCosts();
    })
    .catch(() => alert('Error de conexion al registrar en contabilidad'));
}

function updateShipping() {
    const val = document.getElementById('shippingCostInput').value || 0;
    fetch('{% url "api_update_shipping" %}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
        body: JSON.stringify({order_type: 'catalog', order_id: orderId, shipping_cost: val})
    })
    .then((r) => r.json())
    .then((res) => {
        if (!res.ok) {
            alert(res.error || 'No se pudo actualizar envio');
            return;
        }
        fetchCosts();
    })
    .catch(() => alert('Error de conexion al actualizar envio'));
}

function transitionFinancialState(fsId, newState) {
    const labels = {enviado: 'Enviado', cobrado: 'Cobrado', cancelado: 'Cancelado'};
    if (!confirm('Cambiar estado financiero a ' + labels[newState] + '?')) return;

    fetch('{% url "api_jc_transition" %}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
        body: JSON.stringify({financial_status_id: fsId, new_state: newState})
    })
    .then((r) => r.json())
    .then((res) => {
        if (res.ok) location.reload();
        else alert(res.message || 'Error');
    })
    .catch(() => alert('Error de conexion'));
}

function loadProfitability(fsId) {
    fetch('{% url "api_jc_profitability" %}?financial_status_id=' + fsId)
    .then((r) => r.json())
    .then((res) => {
        if (!res.ok) { alert(res.error); return; }
        const el = document.getElementById('profitData');
        const profit = parseFloat(res.net_profit);
        const cls = profit >= 0 ? 'text-success' : 'text-danger';
        el.innerHTML = `
            <div class="d-flex justify-content-between mb-1"><small>Venta:</small><small class="fw-bold">$${parseInt(res.sale_amount, 10).toLocaleString()}</small></div>
            <div class="d-flex justify-content-between mb-1"><small>Costos:</small><small class="text-danger">-$${parseInt(res.direct_costs, 10).toLocaleString()}</small></div>
            <div class="d-flex justify-content-between mb-1"><small>Envio:</small><small>-$${parseInt(res.shipping_cost, 10).toLocaleString()}</small></div>
            <div class="d-flex justify-content-between mb-1"><small>Overhead (${parseFloat(res.overhead_percentage).toFixed(2)}%):</small><small class="text-warning">-$${parseInt(res.overhead_amount, 10).toLocaleString()}</small></div>
            <div class="d-flex justify-content-between border-top pt-1 mt-1"><small class="fw-bold">Utilidad:</small><small class="fw-bold ${cls}">$${parseInt(res.net_profit, 10).toLocaleString()}</small></div>
        `;
    })
    .catch(() => alert('Error de conexion'));
}

document.getElementById('costTypeInput')?.addEventListener('change', onCostTypeChange);
document.getElementById('costQuantityInput')?.addEventListener('input', calculateCostTotal);
document.getElementById('costUnitPriceInput')?.addEventListener('input', calculateCostTotal);
fetchCosts();
</script>
{% endblock %}
